## 我的数字人即将诞生: 4000余篇github blog文章已喂给大模型  
                                                                    
### 作者                                        
digoal                                        
                                               
### 日期                                             
2024-07-19                                    
                                            
### 标签                                          
PostgreSQL , PolarDB , DuckDB , AI , macOS , ollama , docker , 数字人 , 大模型            
                                                                   
----                                            
                                                          
## 背景    
经过十几年坚持不懈的努力, 我在github已经发表了4000余篇文章, 把这些文章喂给模型后回答一些专业问题, 会不会有更好的效果呢?   
  
请先参考如下文章在macOS中部署ollam: [《低配macbook成功跑AI大模型`LLama3:8b`, 感谢ollama》](../202407/20240718_01.md)    
  
## 一、用我的文章来喂模型  
为了方便使用, 写个python脚本. 嘿嘿, 下面的python脚本也是ollama生成我简单调整了一下.   
  
安装ollama模块  
```  
pip3 install ollama  
```  
  
这个python脚本输入问题, 以及相关的参考文本, 让模型参考文本进行回答.    
```  
vi exp.py  
  
import ollama  
import sys  
  
def read_files(file_paths):  
    file_contents = []  
    for file_path in file_paths:  
        with open(file_path, 'r') as f:  
            for _ in range(14):  
                 next(f)  
            file_contents.append(f.read())  
    return '\n'.join(file_contents)  
  
# Get the file path from the command line argument  
if len(sys.argv) < 3:  
    print("Usage: python script.py [prompt] [file1] [file2] ... ")  
    sys.exit(1)  
  
  
try:  
    prompt = sys.argv[1]  
    file_paths = sys.argv[2:]  
    data = read_files(file_paths)  
  
    output = ollama.generate(  
        model="llama3:8b",  
        prompt=f"请先学习后面提供的参考信息, 使用中文回答这个问题(回答前请先复述问题): {prompt} . 以下全部都是参考信息: {data}"  
    )  
  
    print(output['response'])  
  
except Exception as e:  
    print(f"Error: {e}")  
```  
  
  
使用举例, 让模型参考“## 重新发现PostgreSQL之美 - 9 面向多值列的倒排索引GIN|RUM” 的内容来进行回答.  
```  
python3 ./exp.py "PostgreSQL gin和rum索引的差别是什么? 列举一些SQL例子, 最后做个总结." /Users/digoal/blog/202105/20210531_02.md   
```  
  
模型回答如下  
  
根据提供的参考信息，我将回答这个问题。  
  
问题：关于 PostgreSQL 的 RUM 模块和 rum_anyarray_addon_ops 操作符的使用和示例。  
  
答案：  
  
RUM（Range Unified Manipulation）是 PostgreSQL 中的一个模块，用于对TSVECTOR和ANYARRAY类型进行范围搜索。rum_anyarray_addon_ops 是 rum 模块中的一个操作符，可以用于将ANYARRAY元素存储到索引中，并支持 prefix 搜索。  
  
示例代码：  
```sql  
create extension rum;  
create table tbl (id serial8 primary key, a int[], n int, crt_time timestamp);  
create index idx_tbl_1 on tbl using rum (a rum_anyarray_addon_ops, n) with (attach='n', to='a');  
  
explain (analyze, verbose, timing, costs, buffers) select * from tbl where a @> array[1,2,3] and n <= 1;  
```  
这段代码首先创建了 RUM 扩展，然后创建了一张名为 `tbl` 的表，其中包含一个整数数组列 `a` 和一个 timestamp 列 `crt_time`。接着，使用 rum 模块创建了一个索引 `idx_tbl_1`，用于对 `a` 列和 `n` 列进行范围搜索。  
  
在查询语句中，我们使用了 `@>` 操作符来搜索数组 `a` 中包含 1、2 和 3 的元素，并且要求 `n` 小于或等于 1。结果显示， PostgreSQL 使用的是索引 `idx_tbl_1` 来执行查询，而不是全表扫描。  
  
总的来说，rum_anyarray_addon_ops 操作符可以帮助我们快速地对 ANYARRAY 类型进行范围搜索，并且可以减少查询时间和提高数据库性能。  
  
## 二、会话记忆 & 外脑知识库    
上面是需要我们自己去找相关文章, 然后告诉模型, 能不能让模型自己去找相关文章呢?  
  
还有一种情况是, 模型在交互过程中, 怎么把好的问题和答案收集起来, 方便回答时有上下文的记忆呢? 而不是每次都要你提醒上一次问的是什么.  
  
基于以上问题, 我们需要用到向量数据库.  
  
未来可以把好的答案写入向量数据库、好的参考信息写入向量数据库, 根据会话ID和相似向量提取文本, 作为输入再反馈给模型, 实现模型记忆与外脑知识库.    
  
如何把文本向量化?   
  
再次感谢ollama, 已经集成了embedding模型:   
- https://ollama.com/blog/embedding-models  
- https://ollama.com/library/mxbai-embed-large  
  
使用这个镜像, 拉起PostgreSQL, 内置了vector插件.  用法请参考: https://github.com/pgvector/pgvector    
- [《2023-PostgreSQL Docker镜像学习环境 ARM64版, 已集成热门插件和工具》](../202308/20230814_02.md)      
  
进入容器后, 建表如下:  
```  
psql  
alter role postgres encrypted password '123';  
create extension vector;  
create table tbl (id serial8 primary key, prompt text, answer text, v_prompt vector, v_answer vector);  
-- 索引请参考手册创建  
```  
  
本机可连接映射端口  
```  
docker ps -a --no-trunc  
0.0.0.0:32776->1921/tcp  
```  
  
在本机安装postgresql和psycopg2     
```  
export HOMEBREW_API_DOMAIN="https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles/api"  
export HOMEBREW_BOTTLE_DOMAIN="https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles"  
export HOMEBREW_BREW_GIT_REMOTE="https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git"  
export HOMEBREW_CORE_GIT_REMOTE="https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git"  
export HOMEBREW_PIP_INDEX_URL="https://pypi.tuna.tsinghua.edu.cn/simple"  
brew install postgresql@14  
  
pip3 install psycopg2  
```  
  
编写一个python脚本, 用于提取blog的markdown文件的标题以及内容, 写入向量数据库中.  
```  
vi exp1.py  
  
  
import psycopg2  
import sys  
import ollama  
  
# Define the PostgreSQL connection settings  
HOST = 'localhost'  
PORT = 32776  
DBNAME = 'postgres'  
USER = 'postgres'  
PASSWORD = '123'  
  
# Connect to the PostgreSQL database  
conn = psycopg2.connect(  
    host=HOST,  
    port=PORT,  
    dbname=DBNAME,  
    user=USER,  
    password=PASSWORD  
)  
  
# Get the file path from the command line argument  
if len(sys.argv) != 2:  
    print("Usage: python script.py <file_path>")  
    sys.exit(1)  
file_path = sys.argv[1]  
  
try:  
    # Open the file and read the first line as the prompt  
    with open(file_path, 'r') as f:  
        prompt = f.readline().strip()  
        # answer = f.read()  
        answer = [line for line in f.readlines()[14:]]   
  
    # Create a cursor object to interact with the database  
    cur = conn.cursor()  
  
    v_prompt = ollama.embeddings(model='mxbai-embed-large', prompt=prompt)  
    v_answer = ollama.embeddings(model='mxbai-embed-large', prompt=answer)  
  
    # Insert the prompt and answer into the database  
    cur.execute("INSERT INTO tbl (prompt, answer, v_prompt, v_answer) VALUES (%s, %s)", (prompt, answer))  
  
    # Commit the changes  
    conn.commit()  
  
    print(f"Prompt '{prompt}' and answer written to PostgreSQL database.")  
  
except Exception as e:  
    print(f"Error: {e}")  
finally:  
    # Close the cursor and connection  
    cur.close()  
    conn.close()  
```  
  
用法举例  
```  
python3 ./exp1.py /Users/digoal/blog/202407/20240717_02.md    
  
Prompt '## DuckDB官方推出"社区扩展插件市场", 未来可期' and answer written to PostgreSQL database.  
```  
    
## 三、未完待续  
  
从向量数据库提取相关问题, 然后回答.  
  

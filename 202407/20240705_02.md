## PostgreSQL 18 preview - Add memory/disk usage for Material nodes in EXPLAIN    
                                      
### 作者          
digoal          
                 
### 日期               
2024-07-05            
              
### 标签            
PostgreSQL , PolarDB , DuckDB , explain analyze , Material , memory/disk usage   
                                     
----              
                            
## 背景     
PostgreSQL 18支持explain analyze打印 Material nodes 内存或磁盘消耗.     
  
https://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=1eff8279d494b96f0073df78abc74954a2f6ee54  
```  
Add memory/disk usage for Material nodes in EXPLAIN  
author	David Rowley <drowley@postgresql.org>	  
Fri, 5 Jul 2024 02:05:08 +0000 (14:05 +1200)  
committer	David Rowley <drowley@postgresql.org>	  
Fri, 5 Jul 2024 02:05:08 +0000 (14:05 +1200)  
commit	1eff8279d494b96f0073df78abc74954a2f6ee54  
tree	ad0a2c26cc564a821be0a3ade446b3bfd861c604	tree  
parent	aa86129e19d704afb93cb84ab9638f33d266ee9d	commit | diff  
Add memory/disk usage for Material nodes in EXPLAIN  
  
Up until now, there was no ability to easily determine if a Material  
node caused the underlying tuplestore to spill to disk or even see how  
much memory the tuplestore used if it didn't.  
  
Here we add some new functions to tuplestore.c to query this information  
and add some additional output in EXPLAIN ANALYZE to display this  
information for the Material node.  
  
There are a few other executor node types that use tuplestores, so we  
could also consider adding these details to the EXPLAIN ANALYZE for  
those nodes too.  Let's consider those independently from this.  Having  
the tuplestore.c infrastructure in to allow that is step 1.  
  
Author: David Rowley  
Reviewed-by: Matthias van de Meent, Dmitry Dolgov  
Discussion: https://postgr.es/m/CAApHDvp5Py9g4Rjq7_inL3-MCK1Co2CRt_YWFwTU2zfQix0p4A@mail.gmail.com  
```  
    
```  
+-- Helper function which can be used for masking out portions of EXPLAIN  
+-- ANALYZE which could contain information that's not consistent on all  
+-- platforms.  
+create function explain_analyze(query text) returns setof text  
+language plpgsql as  
+$$  
+declare  
+    ln text;  
+begin  
+    for ln in  
+        execute format('explain (analyze, costs off, summary off, timing off) %s',  
+            query)  
+    loop  
+        ln := regexp_replace(ln, 'Maximum Storage: \d+', 'Maximum Storage: N');  
+        return next ln;  
+    end loop;  
+end;  
+$$;  
```  
  
```  
+select explain_analyze('  
+update ab_a1 set b = 3 from ab where ab.a = 1 and ab.a = ab_a1.a;');  
+                                      explain_analyze   
```  
  
    

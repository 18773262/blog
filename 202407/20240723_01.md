



```
vi q.py


import psycopg2  
import ollama  
import sys 
  
def get_embedding(text):  
    # 调用 ollama.embeddings 获取嵌入值  
    embedding = ollama.embeddings(model='mxbai-embed-large', prompt=text)  
    return embedding  
  
def query_database(embedding):  
    # 连接到 PostgreSQL 数据库  
    conn = psycopg2.connect(  
        dbname="postgres",  
        user="postgres",  
        password="123",  
        host="localhost",  
        port="32776"  
    )  
    cursor = conn.cursor()  
      
    # SQL 查询语句, 查找与标题相似的文本  ORDER BY v_prompt ... , 查找与内容相似的文本用 ORDER BY v_answer ... 
    sql_query = """  
    set local hnsw.ef_search = 1000;   
    SELECT filename, prompt, answer   
    FROM markdown_files   
    ORDER BY v_prompt <=> %s::vector(1024)   
    LIMIT 1;   
    """  
      
    # 执行查询  
    cursor.execute(sql_query, (embedding['embedding'],))  
    results = cursor.fetchall()  
      
    # 打印结果, 返回answer   
    for row in results:   
        # print(f"Filename: {row[0]}, Prompt: {row[1]}, Answer: {row[2]}")  
        print(f"Filename: {row[0]}, Prompt: {row[1]}")  
        return row[1], row[2]
      
    # 关闭连接  
    conn.close()  
  
def main():  
    # Get the file path from the command line argument    
    if len(sys.argv) < 2:    
      print("Usage: python script.py [model] ")    
      sys.exit(1)    

    model = sys.argv[1] 

    # 读取输入问题 
    text = input("请输入你的问题: ")  
      
    # 获取嵌入值  
    embedding = get_embedding(text)  
      
    # 查询数据库并打印结果  
    prompt, answer = query_database(embedding)  

    output_string = f"你是一位PostgreSQL数据库资深DBA, 熟练掌握PostgreSQL数据库原理, 并有大量实践经验, 同时你的学习能力非常强, 可以快速理解新知识. 你的任务是100%准确的解答我的问题, 要求先复述问题, 并且结构清晰通熟易懂.\n下面我会把问题放在 <<<<< >>>>> 符号里面, 把新知识示例的标题放在 [[[[[ ]]]]] 符号里面, 新知识示例的内容放在 ((((( ))))) 符号里面.\n"

    output_string += f"<<<<<\n{text}\n>>>>>\n" 
    output_string += f"[[[[[\n{prompt}\n]]]]]\n(((((\n{answer})))))\n"  

    # print(output_string)

    # 询问ollama 
    output = ollama.generate(    
      model=model,    
      prompt=output_string  
    )    
    
    print(output['response'])  
  
if __name__ == "__main__":  
    main() 
```




```
create extension pg_jieba;
create extension rum;
create index on markdown_files using rum (to_tsvector('jiebacfg', lower(prompt)) rum_tsvector_ops); 

select filename, prompt, 
to_tsvector('jiebacfg', lower(prompt)) <=> to_tsquery(replace(plainto_tsquery('jiebacfg', lower('请介绍一下PostgreSQL bloom索引'))::text, '&', '|'))
from markdown_files 
order by to_tsvector('jiebacfg', lower(prompt)) <=> to_tsquery(replace(plainto_tsquery('jiebacfg', lower('请介绍一下PostgreSQL bloom索引'))::text, '&', '|'))
limit 10; 

    filename    |                                                      prompt                                                      | ?column?  
----------------+------------------------------------------------------------------------------------------------------------------+-----------
 20160523_01.md | ## PostgreSQL 9.6 黑科技 bloom 算法索引，一个索引支撑任意列组合查询                                              | 5.0613356
 20210605_07.md | ## 重新发现PostgreSQL之美 - 14 bloom 布隆过滤器索引                                                              |  5.483114
 20210326_02.md | ## PostgreSQL 14 preview - BRIN (典型IoT 时序场景) 块级索引支持 bloom filter - 随机,大量distinct value, 等值查询 |  5.483114
 20201128_04.md | ## PostgreSQL bloom 索引原理                                                                                     |  5.483114
 20180323_05.md | ## PostgreSQL 11 preview - BRIN索引接口功能扩展(BLOOM FILTER、min max分段)                                       |  5.483114
 20180316_02.md | ## [未完待续] PostgreSQL hash 索引结构介绍                                                                       |  5.483114
 20151021_01.md | ## PostgreSQL Oracle 兼容性 - Oracle反转索引 迁移到PostgreSQL可用函数索引或哈希索引                              | 6.2997475
 20190331_08.md | ## PostgreSQL 12 preview - GiST 索引支持INCLUDE columns - 覆盖索引 - 类聚簇索引                                  | 6.9667797
 20200522_01.md | ## PostgreSQL 用条件索引(部分索引, partial index), 旁路某些索引的使用, 例如sort                                  | 6.9667797
 20200429_01.md | ## PostgreSQL 索引算子下推扩展 - 索引内offset - 索引内过滤 - include index - 随机偏移                            | 6.9667797
(10 rows)



vi q1.py


import psycopg2  
import ollama  
import sys 
  
def query_database(text):  
    # 连接到 PostgreSQL 数据库  
    conn = psycopg2.connect(  
        dbname="postgres",  
        user="postgres",  
        password="123",  
        host="localhost",  
        port="32776"  
    )  
    cursor = conn.cursor()  
      
    # SQL 查询语句, 查找与标题相似的文本  ORDER BY v_prompt ... , 查找与内容相似的文本用 ORDER BY v_answer ... 
    sql_query = """  
    select filename, prompt, answer
    from markdown_files 
    order by to_tsvector('jiebacfg', lower(prompt)) <=> to_tsquery(replace(plainto_tsquery('jiebacfg', lower(%s))::text, '&', '|'))
    limit 1; 
    """  
      
    # 执行查询  
    cursor.execute(sql_query, (text,))  
    results = cursor.fetchall()  
      
    # 打印结果, 返回answer   
    for row in results:   
        # print(f"Filename: {row[0]}, Prompt: {row[1]}, Answer: {row[2]}")  
        print(f"Filename: {row[0]}, Prompt: {row[1]}")  
        return row[1], row[2]
      
    # 关闭连接  
    conn.close()  
  
def main():  
    # Get the file path from the command line argument    
    if len(sys.argv) < 2:    
      print("Usage: python script.py [model] ")    
      sys.exit(1)    

    model = sys.argv[1] 

    # 读取输入问题 
    text = input("请输入你的问题: ")  
      
    # 查询数据库并打印结果  
    prompt, answer = query_database(text)  

    output_string = f"你是一位PostgreSQL数据库资深DBA, 熟练掌握PostgreSQL数据库原理, 并有大量实践经验, 同时你的学习能力非常强, 可以快速理解新知识. 你的任务是100%准确的解答我的问题, 要求先复述问题, 并且结构清晰通熟易懂.\n下面我会把问题放在 <<<<< >>>>> 符号里面, 把新知识示例的标题放在 [[[[[ ]]]]] 符号里面, 新知识示例的内容放在 ((((( ))))) 符号里面.\n"

    output_string += f"<<<<<\n{text}\n>>>>>\n" 
    output_string += f"[[[[[\n{prompt}\n]]]]]\n(((((\n{answer})))))\n"  

    print(output_string)

    # 询问ollama 
    output = ollama.generate(    
      model=model,    
      prompt=output_string  
    )    
    
    print(output['response'])  
  
if __name__ == "__main__":  
    main() 
```





## PostgreSQL白嫖DuckDB实现湖仓一体功能  
                                                            
### 作者                                
digoal                                
                                       
### 日期                                     
2024-07-15                              
                                    
### 标签                                  
PostgreSQL , PolarDB , DuckDB , 湖仓一体 , 对象存储 , parquet , pg_lakehouse , fdw , duckdb_fdw            
                                                           
----                                    
                                                  
## 背景     
  
用duckdb_fdw可以白嫖duckdb访问存储于对象存储中的parquet文件, 提升40倍分析性能.   
  
参考如下文章实操一下找找感觉?     
- [《PG被DuckDB碾压,该反省哪些方面? DuckDB v0.10.3 在Macmini 2023款上的tpch性能表现如何? PostgreSQL使用duckdb_fdw 的tpch加速性能表现如何?》](../202405/20240525_01.md)    
- [《PolarDB-PG | PostgreSQL + duckdb_fdw + 阿里云OSS 实现高效低价的海量数据冷热存储分离》](../202303/20230308_01.md)    
- [《PolarDB 开源版通过 duckdb_fdw 支持 parquet 列存数据文件以及高效OLAP》](../202212/20221209_02.md)    
- [《用duckdb_fdw加速PostgreSQL分析计算, 提速40倍, 真香.》](../202209/20220924_01.md)    
- [《PostgreSQL 牛逼的分析型功能 - 列存储、向量计算 FDW - DuckDB_fdw - 无数据库服务式本地lib库+本地存储》](../202010/20201022_01.md)    
- [《DuckDB DataLake 场景使用举例 - aliyun OSS对象存储parquet》](../202210/20221026_01.md)    
  
但是, duckdb_fdw使用体验还有一定的提升空间, 因为: 每次新增要访问的parquet文件都需要重新定义duckdb视图, 持久化数据文件, 然后定义pg外部表, 最后还需要在每次访问对象存储前都需要设置访问akid,key,region等.    
  
一次操作  
- 创建duckdb_fdw插件  
- 创建foreign server  
- 定义对象存储secret (实测目前还不支持alibabacloud oss)  
- 创建duckdb 视图, 访问对象存储parquet文件  
- 保存duckdb数据文件  
- 创建foreign table  
  
每当访问外部表(ft)时  
- 需要先配置一下duckdb fdw server连接对象存储的参数 (实测支持alibabacloud oss)  
- 读取foreign table  
  
每当需要访问新的文件时都需要重新创建ft   
- 设置访问对象存储参数(akid,key,region) (实测支持alibabacloud oss)  
- 创建duckdb 视图, 访问对象存储parquet文件  
- 保存duckdb数据文件  
- 创建foreign table  
  
  
是不是挺繁琐?    
  
如何让PG像DuckDB一样无忧的访问对象存储parquet并利用duckdb的算力呢? 目前看到crunchydata的云服务有点这意思, 参考如下文章:  
- [《什么? PostgreSQL大佬tom lane公司crunchydata“模仿”DuckDB创意?》](../202405/20240506_02.md)    
  
在duckdb中原生访问对象存储中的parquet就非常方便, 一个函数即可, 甚至直接指定文件路径即可.   
  
例子.  
  
使用这个阿里云免费云起实验, 创建免费的oss.    
- https://developer.aliyun.com/adc/scenario/exp/f55dbfac77c0467a9d3cd95ff6697a31  
  
使用无敌pg docker image测试:    
```  
root@591fb57b3bcd:~# su - postgres  
postgres@591fb57b3bcd:~$ ./duckdb   
v1.0.0 1f98600c2c  
Enter ".help" for usage hints.  
Connected to a transient in-memory database.  
Use ".open FILENAME" to reopen on a persistent database.  
  
D INSTALL httpfs;    
100% ▕████████████████████████████████████████████████████████████▏   
D LOAD httpfs;    
  
D create table a(id int, info text);    
D insert into a select range, md5(random()::text) from range(1,10000000);    
100% ▕████████████████████████████████████████████████████████████▏   
  
D set s3_access_key_id='xxx';    
D set s3_secret_access_key='xxx';   
D set s3_endpoint='s3.oss-cn-shanghai.aliyuncs.com';     
  
D copy a to 's3://otpawu20240715105432/a.parquet';         
100% ▕████████████████████████████████████████████████████████████▏   
  
D .timer on  
D SELECT * FROM read_parquet('s3://otpawu20240715105432/a.parquet') where id<10;    
┌───────┬──────────────────────────────────┐  
│  id   │               info               │  
│ int32 │             varchar              │  
├───────┼──────────────────────────────────┤  
│     1 │ 9185f0cf7a5ccd6bdc8a2314530b4874 │  
│     2 │ 58497506c65c04de46ffc9d01e04d472 │  
│     3 │ 7a85c95187b915e44d67a7fe4a180b84 │  
│     4 │ 65fcdc0e4ce9c4a91a33dbc36ce08c92 │  
│     5 │ 280c0adaae99569ae9520510ffbf645f │  
│     6 │ 4f9f28139f2a1e5ada45a92631d70dca │  
│     7 │ d5893b650320eb5d989b7ffa176e4310 │  
│     8 │ 98b01fa73dd9005db77b480ee30d6082 │  
│     9 │ ed1256892a1ab3aae2a2fd51771fbea5 │  
└───────┴──────────────────────────────────┘  
Run Time (s): real 1.532 user 1.429763 sys 0.018154  
  
D SELECT * FROM read_parquet('s3://otpawu20240715105432/a.parquet') where id<10;    
┌───────┬──────────────────────────────────┐  
│  id   │               info               │  
│ int32 │             varchar              │  
├───────┼──────────────────────────────────┤  
│     1 │ 9185f0cf7a5ccd6bdc8a2314530b4874 │  
│     2 │ 58497506c65c04de46ffc9d01e04d472 │  
│     3 │ 7a85c95187b915e44d67a7fe4a180b84 │  
│     4 │ 65fcdc0e4ce9c4a91a33dbc36ce08c92 │  
│     5 │ 280c0adaae99569ae9520510ffbf645f │  
│     6 │ 4f9f28139f2a1e5ada45a92631d70dca │  
│     7 │ d5893b650320eb5d989b7ffa176e4310 │  
│     8 │ 98b01fa73dd9005db77b480ee30d6082 │  
│     9 │ ed1256892a1ab3aae2a2fd51771fbea5 │  
└───────┴──────────────────────────────────┘  
Run Time (s): real 1.586 user 1.481081 sys 0.014454  
  
D select count(*) from read_parquet('s3://otpawu20240715105432/a.parquet');  
┌──────────────┐  
│ count_star() │  
│    int64     │  
├──────────────┤  
│      9999999 │  
└──────────────┘  
Run Time (s): real 0.155 user 0.029418 sys 0.004126  
  
D select count(*),min(id),max(id),avg(id) from read_parquet('s3://otpawu20240715105432/a.parquet');  
100% ▕████████████████████████████████████████████████████████████▏   
┌──────────────┬─────────┬─────────┬───────────┐  
│ count_star() │ min(id) │ max(id) │  avg(id)  │  
│    int64     │  int32  │  int32  │  double   │  
├──────────────┼─────────┼─────────┼───────────┤  
│      9999999 │       1 │ 9999999 │ 5000000.0 │  
└──────────────┴─────────┴─────────┴───────────┘  
Run Time (s): real 10.665 user 1.998380 sys 0.765886  
  
D select count(*),min(id),max(id),avg(id) from read_parquet('s3://otpawu20240715105432/a.parquet');  
100% ▕████████████████████████████████████████████████████████████▏   
┌──────────────┬─────────┬─────────┬───────────┐  
│ count_star() │ min(id) │ max(id) │  avg(id)  │  
│    int64     │  int32  │  int32  │  double   │  
├──────────────┼─────────┼─────────┼───────────┤  
│      9999999 │       1 │ 9999999 │ 5000000.0 │  
└──────────────┴─────────┴─────────┴───────────┘  
Run Time (s): real 9.397 user 1.978366 sys 0.689697  
  
D select count(*),min(id),max(id) from read_parquet('s3://otpawu20240715105432/a.parquet');  
100% ▕████████████████████████████████████████████████████████████▏   
┌──────────────┬─────────┬─────────┐  
│ count_star() │ min(id) │ max(id) │  
│    int64     │  int32  │  int32  │  
├──────────────┼─────────┼─────────┤  
│      9999999 │       1 │ 9999999 │  
└──────────────┴─────────┴─────────┘  
Run Time (s): real 10.768 user 2.101236 sys 0.575175  
```  
  
PS, 目前duckdb secret语法不支持alibabacloud oss:  
```  
D CREATE SECRET my_secret (  
      TYPE S3,  
      KEY_ID 'xxx',  
      SECRET 'xxx',  
      REGION 's3.oss-cn-shanghai.aliyuncs.com'  
  );  
┌─────────┐  
│ Success │  
│ boolean │  
├─────────┤  
│ true    │  
└─────────┘  
  
D create table a(id int, info text);    
D insert into a select range, md5(random()::text) from range(1,1000000);  
D copy a to 's3://ewhyuq20240715135329/a.parquet';      
HTTP Error: Unable to connect to URL "https://ewhyuq20240715135329.s3.amazonaws.com/a.parquet": 400 (Bad Request)  
```  
  
DuckDB访问对象存储parquet文件不需要任何提前定义, 自动发现parquet schema, 直接访问即可.    
  
  
## pg_lakehouse 来了  
pg_lakehouse, 看名字知道湖仓一体. 实际上就是结合了PG和duckdb, 一样使用fdw接口, 和duckdb_fdw不一样的地方是支持更多option, 在user mapping中定义对象存储的akid、key、region, 在ft的option中定义对象存储中的parquet文件位置. 如果你经常访问的数据都存储在对象存储里面, 使用pg_lakehouse就比较方便.  
  
例子  
```  
postgres@591fb57b3bcd:~$ psql  
psql (14.12 (Debian 14.12-1.pgdg110+1))  
Type "help" for help.  
  
postgres=# create extension pg_lakehouse;  
CREATE EXTENSION  
postgres=# \dx  
                                List of installed extensions  
     Name     | Version |   Schema   |                      Description                        
--------------+---------+------------+-------------------------------------------------------  
 pg_lakehouse | 0.8.4   | public     | pg_lakehouse: An analytical query engine for Postgres  
 plpgsql      | 1.0     | pg_catalog | PL/pgSQL procedural language  
(2 rows)  
  
  
-- Parquet format is assumed  
  
CREATE FOREIGN DATA WRAPPER parquet_wrapper  
HANDLER parquet_fdw_handler  
VALIDATOR parquet_fdw_validator;  
  
CREATE SERVER parquet_server  
FOREIGN DATA WRAPPER parquet_wrapper;  
  
drop user MAPPING IF EXISTS FOR postgres SERVER parquet_server ;  
  
CREATE USER MAPPING FOR postgres  
SERVER parquet_server  
OPTIONS (  
  type 'S3',  
  key_id 'xxx',  
  secret 'xxx',  
  region 's3.oss-cn-shanghai.aliyuncs.com'  
);  
```  
  
创建外部表, 目前的报错和duckdb有关, secret暂时还不支持alibabacloud oss.   
```  
CREATE FOREIGN TABLE a ()  
SERVER parquet_server  
OPTIONS (files 's3://otpawu20240715105432/a.parquet');  
  
ERROR:  HTTP Error: HTTP GET error on 'https://otpawu20240715105432.s3.amazonaws.com/a.parquet' (HTTP 400)  
  
  
CREATE FOREIGN TABLE a ()  
SERVER parquet_server  
OPTIONS (files 'https://otpawu20240715105432.s3.oss-cn-shanghai.aliyuncs.com/a.parquet');  
  
ERROR:  HTTP Error: HTTP GET error on 'https://otpawu20240715105432.s3.oss-cn-shanghai.aliyuncs.com/a.parquet' (HTTP 403)  
  
  
CREATE FOREIGN TABLE a ()  
SERVER parquet_server  
OPTIONS (files 'https://otpawu20240715105432.oss-cn-shanghai.aliyuncs.com/a.parquet');  
  
ERROR:  HTTP Error: HTTP GET error on 'https://otpawu20240715105432.oss-cn-shanghai.aliyuncs.com/a.parquet' (HTTP 403)  
```  
  
期待duckdb secret支持alibabacloud oss.    
  
## 参考  
https://developer.aliyun.com/adc/scenario/exp/f55dbfac77c0467a9d3cd95ff6697a31  
  
https://help.aliyun.com/zh/oss/developer-reference/migrate-data-from-amazon-s3-to-alibaba-cloud-oss-1  
  
https://docs.paradedb.com/analytics/object_stores/s3  
  
https://github.com/paradedb/paradedb/blob/dev/docs/analytics/object_stores/s3.mdx  
  

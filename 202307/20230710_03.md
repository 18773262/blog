## amd64 , 使用Dockerfile+docker build制作PolarDB | PostgreSQL 开源docker镜像, 集成大量插件方便学习, 并推送到阿里云镜像服务  
  
### 作者  
digoal  
  
### 日期  
2023-07-10  
  
### 标签  
PostgreSQL , PolarDB , docker , 插件 , Dockerfile , docker build  
  
----  
  
## 背景  
如果你使用的是Apple chip, 可以参考这篇:  
- [《arm64 , 使用Dockerfile+docker build制作PolarDB | PostgreSQL 开源docker镜像, 集成大量插件方便学习, 并推送到阿里云镜像服务》](../202308/20230814_02.md)  
  
##### 202307/20230710_02.md   [《制作PolarDB | PostgreSQL 开源docker镜像, 集成大量插件方便学习, 并推送到阿里云镜像服务》](../202307/20230710_02.md)  
##### 202307/20230710_01.md   [《配置阿里云 Docker 镜像加速服务, 以及如何查找官方镜像tags 信息》](../202307/20230710_01.md)  
  
这个镜像集成了186个扩展插件, 提升业务开发效率, 解决业务问题等, 涉及各个领域, 参考末尾介绍. 以及若干数据库管理工具(例如pg_rman, pgpool等).  
  
如果你发现镜像的问题, 或者想集成其他插件, 欢迎[发issue](https://github.com/digoal/blog/issues)给我, 我会尽快回复.  
  
希望这个镜像能够降低学习数据库的门槛, 帮助高校和培训机构以及学习者能够有统一的学习环境, 不再为环境问题而影响教学练, 让大家可以快速的接触到各个领域的知识, 为中国数据库人才培养添砖加瓦.  
  
## 如何使用这个镜像  
我已经配置为公开模式, 任何人都可以下载学习使用, 已经集成到[云起实验室]([https://developer.aliyun.com/adc](https://developer.aliyun.com/adc/scenario/exp/f55dbfac77c0467a9d3cd95ff6697a31)), [云起实验]([https://developer.aliyun.com/adc](https://developer.aliyun.com/adc/scenario/exp/f55dbfac77c0467a9d3cd95ff6697a31))永久免费提供给PostgreSQL数据库开源爱好者、PostgreSQL数据库教学.  
  
```  
# 拉取镜像, 第一次拉取一次即可.  
docker pull registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pg14_with_exts  
  
# 启动容器  
docker run --platform linux/amd64 -d -it -P --cap-add=SYS_PTRACE --cap-add SYS_ADMIN --privileged=true --name pg --shm-size=1g registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pg14_with_exts  
  
# 进入容器  
docker exec -ti pg bash  
  
# 连接数据库  
psql  
```  
  
插件列表:  
```  
Display all 186 possibilities? (y or n)
address_standardizer                            imgsmlr                                         pgpool_recovery                                 pointcloud
"address_standardizer-3"                        insert_username                                 pgpool_regclass                                 pointcloud_postgis
address_standardizer_data_us                    intagg                                          pg_prewarm                                      postgis
"address_standardizer_data_us-3"                intarray                                        pg_profile                                      "postgis-3"
adminpack                                       ip4r                                            pg_qualstats                                    postgis_raster
age                                             isn                                             pg_query_rewrite                                "postgis_raster-3"
aggs_for_vecs                                   jsonb_plpython3u                                pg_rational                                     postgis_sfcgal
amcheck                                         jsquery                                         pg_repack                                       "postgis_sfcgal-3"
anon                                            lantern                                         pgroonga                                        postgis_tiger_geocoder
autoinc                                         lantern_extras                                  pgroonga_database                               "postgis_tiger_geocoder-3"
aws_s3                                          lo                                              pgrouting                                       postgis_topology
bloom                                           ltree                                           pgrowlocks                                      "postgis_topology-3"
btree_gin                                       ltree_plpython3u                                pg_safer_settings                               postgres_fdw
btree_gist                                      mimeo                                           pg_safer_settings_table_dependent_extension     powa
citext                                          moddatetime                                     pg_safer_settings_table_dependent_subextension  prefix
citus                                           mongo_fdw                                       pgsentinel                                      pre_prepare
citus_columnar                                  mysql_fdw                                       pg_show_plans                                   prioritize
columnar                                        ogr_fdw                                         pg_similarity                                   q3c
credcheck                                       old_snapshot                                    pgsodium                                        quantile
cube                                            oracle_fdw                                      pg_sphere                                       rdkit
datasketches                                    orafce                                          pg_squeeze                                      refint
dblink                                          pageinspect                                     pg_stat_kcache                                  roaringbitmap
dblink_plus                                     parquet_fdw                                     pg_stat_monitor                                 rum
ddlx                                            parray_gin                                      pg_stat_statements                              seg
decoderbufs                                     pgagent                                         pgstattuple                                     smlar
dict_int                                        pgaudit                                         pg_statviz                                      sslinfo
dict_xsyn                                       pg_bigm                                         pg_store_plans                                  tablefunc
duckdb_fdw                                      pg_buffercache                                  pg_surgery                                      table_log
earthdistance                                   pg_bulkload                                     pgtap                                           tcn
embedding                                       pg_cron                                         pg_tiktoken                                     tdigest
extra_window_functions                          pgcrypto                                        pg_track_settings                               tds_fdw
file_fdw                                        pg_curl                                         pg_trgm                                         temporal_tables
first_last_agg                                  pg_dbms_stats                                   pgtt                                            timescaledb
fuzzystrmatch                                   pg_dirtyread                                    pg_utility_trigger_functions                    timescaledb_toolkit
gevel                                           pgfaceting                                      pg_uuidv7                                       toastinfo
h3                                              pgfincore                                       pg_variables                                    tsm_system_rows
h3_postgis                                      pg_freespacemap                                 pg_visibility                                   tsm_system_time
hdfs_fdw                                        pggraphblas                                     pg_wait_sampling                                unaccent
hll                                             pg_hint_plan                                    pldbgapi                                        unit
hnsw                                            pg_ivm                                          pljava                                          "uuid-ossp"
hstore                                          pg_jieba                                        pllua                                           vector
hstore_pllua                                    pgjwt                                           plluau                                          vops
hstore_plluau                                   pgmemcache                                      plpgsql_check                                   xml2
hstore_plpython3u                               pgmp                                            plprofiler                                      zhparser
http                                            pg_net                                          plproxy                                         zson
hypopg                                          pg_onnx                                         plpython3u                                      
icu_ext                                         pgpool_adm                                      plr 
```  
  
使用duckdb:  
```  
# 进入容器  
docker exec -ti pg bash  
  
# 切换用户  
su - postgres  
  
# 启动duckdb  
./duckdb  
```  
  
## 云起实验室实验简介  
免费云起实验室地址:  
- https://developer.aliyun.com/adc/scenario/exp/f55dbfac77c0467a9d3cd95ff6697a31  
  
  
内置PolarDB-X, PolarDB-PG, PostgreSQL容器镜像:  
```  
[root@iZuf6g6afqwaglx4kxuskxZ ~]# docker images  
REPOSITORY                                                     TAG              IMAGE ID       CREATED        SIZE  
registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database   pg14_with_exts   1b9d30ed2910   5 days ago     5.25GB  
polardbx/polardb-x                                             latest           f4da3f72d974   3 months ago   2.91GB  
polardb/polardb_pg_local_instance                              htap             62fcb916564e   3 months ago   5.65GB  
polardb/polardb_pg_devel                                       latest           bc8f10854b35   3 months ago   1.92GB  
```  
  
操作方法:  
  
1、PolarDB-PG  
  
创建并启动容器  
```  
docker run -d -it -P --cap-add=SYS_PTRACE --privileged=true --name polardb-pg polardb/polardb_pg_local_instance:htap  
```  
进入容器  
```  
docker exec -ti polardb-pg bash  
```  
连接数据库  
```  
psql -h 127.0.0.1 -c 'select version();'  
```  
停止容器  
```  
docker stop polardb-pg  
```  
删除容器  
```  
docker rm polardb-pg  
```  
  
2、PolarDB-X  
  
创建并启动容器  
```  
docker run -d --name polardb-x -p 8527:8527 polardbx/polardb-x  
```  
进入容器  
```  
docker exec -ti polardb-x bash  
```  
连接数据库  
```  
mysql -h127.0.0.1 -P8527 -upolardbx_root -p123456  
```  
停止容器  
```  
docker stop polardb-x  
```  
删除容器  
```  
docker rm polardb-x  
```  
  
3、PostgreSQL  
  
创建并启动容器  
```  
docker run --platform linux/amd64 -d -it -P --cap-add=SYS_PTRACE --cap-add SYS_ADMIN --privileged=true --name pg --shm-size=1g registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pg14_with_exts  
```  
  
进入容器  
```  
docker exec -ti pg bash  
```  
  
连接数据库  
```  
psql  
```  
  
停止容器  
```  
docker stop pg  
```  
  
删除容器  
```  
docker rm pg  
```  
  
  
  
## 使用docker build + Dockerfile 制作PolarDB | PostgreSQL 开源docker镜像, 集成大量插件方便学习  
1、创建Dockerfile工作目录:  
  
```  
mkdir ~/pg14  
```  
  
  
2、下载Oracle OCI到Dockerfile工作目录. (oracle_fdw, dblink_plus插件依赖oracle library.)  
  
[《PostgreSQL 商用版本EPAS(阿里云ppas) - 测试环境部署(EPAS 安装、配置、管理、Oracle DBLINK、外表)》](../201801/20180119_01.md)  
  
http://www.oracle.com/technetwork/database/features/instant-client/index-097480.html  
  
```  
cd ~/Downloads  
unzip instantclient-basic-linux.x64-12.2.0.1.0.zip  
unzip instantclient-sdk-linux.x64-12.2.0.1.0.zip  
  
mv instantclient_12_2 ~/pg14/  
cd ~/pg14/instantclient_12_2  
ln -s libclntsh.so.12.1 libclntsh.so  
  
cd ~/pg14  
  
  
IT-C02YW2EFLVDL:pg14 digoal$ ll -R  
total 56  
-rw-r--r--    1 digoal  staff   3.3K Jul 12 09:58 1.sh  
-rw-r--r--    1 digoal  staff   2.0K Jul 12 09:58 2.sh  
-rw-r--r--    1 digoal  staff   575B Jul 12 09:59 4.sh  
-rw-r--r--    1 digoal  staff   2.3K Jul 12 09:59 5.sh  
-rw-r--r--    1 digoal  staff   6.2K Jul 12 11:30 3.sh  
-rw-r--r--    1 digoal  staff   3.3K Jul 12 12:43 Dockerfile  
drwxr-xr-x+ 110 digoal  staff   3.4K Jul 12 12:43 ..  
drwxr-xr-x    9 digoal  staff   288B Jul 12 12:43 .  
drwxr-xr-x@  20 digoal  staff   640B Jul 12 12:44 instantclient_12_2  
  
./instantclient_12_2:  
total 433376  
-rwxrwxr-x@  1 digoal  staff   119M Jan 26  2017 libociei.so  
-rwxrwxr-x@  1 digoal  staff    56K Jan 26  2017 genezi  
-rwxrwxr-x@  1 digoal  staff   235K Jan 26  2017 uidrvci  
-rwxrwxr-x@  1 digoal  staff   114K Jan 26  2017 liboramysql12.so  
-r-xr-xr-x@  1 digoal  staff   372K Jan 26  2017 libons.so  
-r-xr-xr-x@  1 digoal  staff   6.3M Jan 26  2017 libnnz12.so  
-rwxrwxr-x@  1 digoal  staff    43K Jan 26  2017 adrci  
-rw-rw-r--@  1 digoal  staff   363B Jan 26  2017 BASIC_README  
-rw-rw-r--@  1 digoal  staff    72K Jan 26  2017 xstreams.jar  
-r--r--r--@  1 digoal  staff   3.8M Jan 26  2017 ojdbc8.jar  
-r-xr-xr-x@  1 digoal  staff   155K Jan 26  2017 libocijdbc12.so  
-rwxrwxr-x@  1 digoal  staff   2.1M Jan 26  2017 libocci.so.12.1  
-r-xr-xr-x@  1 digoal  staff   526K Jan 26  2017 libmql1.so  
-r-xr-xr-x@  1 digoal  staff   2.8M Jan 26  2017 libipc1.so  
-rwxrwxr-x@  1 digoal  staff   7.7M Jan 26  2017 libclntshcore.so.12.1  
-rwxrwxr-x@  1 digoal  staff    68M Jan 26  2017 libclntsh.so.12.1  
drwxrwxr-x@  8 digoal  staff   256B Jan 26  2017 sdk  
drwxr-xr-x   9 digoal  staff   288B Jul 12 12:43 ..  
lrwxr-xr-x   1 digoal  staff    17B Jul 12 12:44 libclntsh.so -> libclntsh.so.12.1  
drwxr-xr-x@ 20 digoal  staff   640B Jul 12 12:44 .  
  
./instantclient_12_2/sdk:  
total 632  
-rw-rw-r--@  1 digoal  staff   359B Jan 26  2017 SDK_README  
drwxrwxr-x@ 31 digoal  staff   992B Jan 26  2017 include  
drwxrwxr-x@  3 digoal  staff    96B Jan 26  2017 admin  
-rw-rw-r--@  1 digoal  staff   306K Jan 26  2017 ottclasses.zip  
-r-xr-xr-x@  1 digoal  staff   874B Jan 26  2017 ott  
drwxrwxr-x@ 11 digoal  staff   352B Jan 26  2017 demo  
drwxrwxr-x@  8 digoal  staff   256B Jan 26  2017 .  
drwxr-xr-x@ 20 digoal  staff   640B Jul 12 12:44 ..  
  
./instantclient_12_2/sdk/include:  
total 3408  
-r-xr-xr-x@  1 digoal  staff    24K Jan 26  2017 occiObjects.h  
-r-xr-xr-x@  1 digoal  staff    39K Jan 26  2017 occiData.h  
-r-xr-xr-x@  1 digoal  staff    71K Jan 26  2017 occiControl.h  
-r-xr-xr-x@  1 digoal  staff    35K Jan 26  2017 occiCommon.h  
-r-xr-xr-x@  1 digoal  staff   2.1K Jan 26  2017 occi.h  
-r-xr-xr-x@  1 digoal  staff   8.7K Jan 26  2017 ociextp.h  
-r-xr-xr-x@  1 digoal  staff    12K Jan 26  2017 ocidfn.h  
-r-xr-xr-x@  1 digoal  staff   4.0K Jan 26  2017 ocidem.h  
-r-xr-xr-x@  1 digoal  staff    42K Jan 26  2017 ocidef.h  
-r-xr-xr-x@  1 digoal  staff   6.1K Jan 26  2017 ociapr.h  
-r-xr-xr-x@  1 digoal  staff   428K Jan 26  2017 ociap.h  
-r-xr-xr-x@  1 digoal  staff    10K Jan 26  2017 oci8dp.h  
-r-xr-xr-x@  1 digoal  staff   7.0K Jan 26  2017 oci1.h  
-r-xr-xr-x@  1 digoal  staff   190K Jan 26  2017 oci.h  
-r-xr-xr-x@  1 digoal  staff    11K Jan 26  2017 occiAQ.h  
-r-xr-xr-x@  1 digoal  staff   9.7K Jan 26  2017 xa.h  
-r-xr-xr-x@  1 digoal  staff   121K Jan 26  2017 ort.h  
-r-xr-xr-x@  1 digoal  staff    42K Jan 26  2017 oro.h  
-r-xr-xr-x@  1 digoal  staff   155K Jan 26  2017 orl.h  
-r-xr-xr-x@  1 digoal  staff    15K Jan 26  2017 orid.h  
-r-xr-xr-x@  1 digoal  staff   100K Jan 26  2017 ori.h  
-r-xr-xr-x@  1 digoal  staff   6.4K Jan 26  2017 oratypes.h  
-r-xr-xr-x@  1 digoal  staff    32K Jan 26  2017 odci.h  
-r-xr-xr-x@  1 digoal  staff   109K Jan 26  2017 ocixstream.h  
-r-xr-xr-x@  1 digoal  staff   7.9K Jan 26  2017 ocixmldb.h  
-r-xr-xr-x@  1 digoal  staff   6.3K Jan 26  2017 ocikpr.h  
-r-xr-xr-x@  1 digoal  staff    77K Jan 26  2017 nzt.h  
-r-xr-xr-x@  1 digoal  staff    37K Jan 26  2017 nzerror.h  
-r-xr-xr-x@  1 digoal  staff    44K Jan 26  2017 ldap.h  
drwxrwxr-x@ 31 digoal  staff   992B Jan 26  2017 .  
drwxrwxr-x@  8 digoal  staff   256B Jan 26  2017 ..  
  
./instantclient_12_2/sdk/admin:  
total 24  
-r-xr-xr-x@ 1 digoal  staff   9.8K Jan 26  2017 oraaccess.xsd  
drwxrwxr-x@ 3 digoal  staff    96B Jan 26  2017 .  
drwxrwxr-x@ 8 digoal  staff   256B Jan 26  2017 ..  
  
./instantclient_12_2/sdk/demo:  
total 152  
-rwxrwxr-x@  1 digoal  staff   4.2K Jan 26  2017 demo.mk  
-r-xr-xr-x@  1 digoal  staff   6.6K Jan 26  2017 setuporamysql.sh  
-r-xr-xr-x@  1 digoal  staff   1.1K Jan 26  2017 oraaccess.xml  
-r-xr-xr-x@  1 digoal  staff    60B Jan 26  2017 occiobj.typ  
-r-xr-xr-x@  1 digoal  staff   4.8K Jan 26  2017 occiobj.cpp  
-r-xr-xr-x@  1 digoal  staff   7.5K Jan 26  2017 occidml.cpp  
-r-xr-xr-x@  1 digoal  staff   1.9K Jan 26  2017 occidemod.sql  
-r-xr-xr-x@  1 digoal  staff   8.2K Jan 26  2017 occidemo.sql  
-r-xr-xr-x@  1 digoal  staff    17K Jan 26  2017 cdemo81.c  
drwxrwxr-x@  8 digoal  staff   256B Jan 26  2017 ..  
drwxrwxr-x@ 11 digoal  staff   352B Jan 26  2017 .  
```  
  
2\.1、下载几个较大的源码包, 降低在docker build时下载报错导致build失败的概率.  
  
```  
cd ~/pg14  
  
curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L http://faculty.cse.tamu.edu/davis/GraphBLAS/GraphBLAS-3.1.1.tar.gz -o GraphBLAS-3.1.1.tar.gz  
  
curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L https://github.com/duckdb/duckdb/releases/download/v0.9.0/libduckdb-linux-amd64.zip -o libduckdb-linux-amd64.zip  
  
curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L https://github.com/duckdb/duckdb/releases/download/v0.9.0/duckdb_cli-linux-amd64.zip -o duckdb_cli-linux-amd64.zip  
  
curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L https://github.com/Kitware/CMake/releases/download/v3.27.4/cmake-3.27.4.tar.gz -o cmake-3.27.4.tar.gz

curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L https://github.com/mongodb/mongo-c-driver/releases/download/1.17.3/mongo-c-driver-1.17.3.tar.gz -o mongo-c-driver-1.17.3.tar.gz

curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L https://github.com/json-c/json-c/archive/json-c-0.15-20200726.tar.gz -o json-c-0.15-20200726.tar.gz
  
curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L https://github.com/microsoft/onnxruntime/releases/download/v1.15.1/onnxruntime-linux-x64-1.15.1.tgz -o onnxruntime-linux-x64-1.15.1.tgz

curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L https://nodejs.org/download/release/v14.21.3/node-v14.21.3.tar.gz -o node-v14.21.3.tar.gz
```
  
参考文档打包pg_tiktoken:  
- [《PostgreSQL 或PolarDB 使用插件pg_tiktoken - 使用 OpenAI tiktoken库文本向量化(tokenization) - 使用分词算法BPE - NLP 自然语言处理》](../202307/20230706_05.md)
  
参考文档打包lantern_extras:  
- [《PolarDB|PG AI 功能练习插件: lantern_extras》](../202309/20230922_01.md)  
  
3、准备脚本, 参考末尾`Max depth exceeded`报错, 目的是减少dockerfile步骤. 但是写成一堆脚本不太好调试, 建议先手工制作后再用Dockerfile来制作.  
  
```  
cd ~/pg14  
```  
  
```  
vi 1.sh  
```  
  
```  
#!/bin/bash  
set -vx  
  
cd /tmp  
sed -i "s@http://\(deb\|security\).debian.org@http://mirrors.aliyun.com@g" /etc/apt/sources.list  
apt-get update  
apt-get reinstall -y apt-transport-https ca-certificates  
sed -i "s@http://mirrors.aliyun.com@https://mirrors.aliyun.com@g" /etc/apt/sources.list  
apt-get update  
apt-get install -y lsb-release wget vim man  
  
# RUN echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list  
echo "deb https://mirrors.tuna.tsinghua.edu.cn/postgresql/repos/apt/ $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list  
apt-get install -y gnupg2  
  
# RUN wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -  
wget --quiet -O - https://mirrors.tuna.tsinghua.edu.cn/postgresql/repos/apt/ACCC4CF8.asc | apt-key add -  
apt-get update  
apt-get install -y locales  
localedef -i en_US -f UTF-8 en_US.UTF-8  
  
apt-get install -y curl libicu-dev icu-devtools libbison-dev libfl-dev git libreadline-dev libedit-dev g++ make cmake man-db dnsutils clang libssl-dev default-jdk  
apt-get install -y unixodbc unixodbc-dev bash-completion m4 python3-distutils python glibc-source zlib1g-dev pkg-config default-jre openjdk-17-jdk openjdk-17-jdk-headless  
apt-get install -y postgresql-14 postgresql-client-14 postgresql-server-dev-14 postgresql-doc-14  
apt-get install -y postgresql-14-dirtyread postgresql-14-extra-window-functions postgresql-14-first-last-agg postgresql-14-hll postgresql-14-hypopg  
apt-get install -y postgresql-14-ip4r postgresql-14-mysql-fdw postgresql-14-jsquery postgresql-14-ogr-fdw postgresql-14-oracle-fdw postgresql-14-pgmemcache  
apt-get install -y postgresql-14-pljava postgresql-14-pllua postgresql-14-plpgsql-check postgresql-14-plproxy postgresql-14-prefix postgresql-14-rational  
apt-get install -y postgresql-14-rdkit postgresql-14-orafce postgresql-14-pg-qualstats postgresql-14-pg-stat-kcache  
apt-get install -y postgresql-14-pg-wait-sampling postgresql-14-pgfincore postgresql-14-pgaudit postgresql-14-pgpool2 postgresql-14-pgrouting postgresql-14-pgrouting-doc  
apt-get install -y postgresql-14-pgrouting-scripts postgresql-14-pgsphere postgresql-14-pgvector postgresql-14-pldebugger postgresql-14-pointcloud postgresql-14-plr  
apt-get install -y postgresql-14-postgis-3 postgresql-14-postgis-3-scripts postgresql-14-powa postgresql-14-q3c postgresql-14-repack  
apt-get install -y postgresql-14-rum postgresql-14-show-plans postgresql-14-similarity postgresql-14-tablelog postgresql-14-tdigest postgresql-14-wal2json  
apt-get install -y postgresql-14-tds-fdw postgresql-14-plprofiler postgresql-14-cron  
apt-get install -y pgagroal pgpool2 pgbouncer pgxnclient pgagent postgresql-plpython3-14 postgresql-14-icu-ext libpq-dev  
  
echo "deb https://packagecloud.io/timescale/timescaledb/debian/ $(lsb_release -c -s) main" | tee /etc/apt/sources.list.d/timescaledb.list  
wget --quiet -O - https://packagecloud.io/timescale/timescaledb/gpgkey | gpg --dearmor -o /etc/apt/trusted.gpg.d/timescaledb.gpg  
apt-get update  
apt-get install -y timescaledb-2-postgresql-14  
  
wget https://packages.groonga.org/debian/groonga-apt-source-latest-bullseye.deb  
apt-get install -y -V ./groonga-apt-source-latest-bullseye.deb  
apt-get update  
apt-get install -y postgresql-14-pgdg-pgroonga

apt-get install -y postgresql-14-credcheck postgresql-14-decoderbufs postgresql-14-mimeo postgresql-14-pgmp postgresql-14-preprepare postgresql-14-prioritize postgresql-14-squeeze postgresql-14-toastinfo postgresql-14-unit
```  
  
```  
vi 2.sh  
```  
  
```  
#!/bin/bash  
set -vx  
  
export ROOT_HOME=/root  
echo "#  add by digoal" >>$ROOT_HOME/.bashrc  
echo "alias rm='rm -i'" >>$ROOT_HOME/.bashrc  
echo "alias cp='cp -i'" >>$ROOT_HOME/.bashrc  
echo "alias ll='ls -larth'" >>$ROOT_HOME/.bashrc  
echo "alias mv='mv -i'" >>$ROOT_HOME/.bashrc  
echo "export PGHOME=/usr/lib/postgresql/14" >>$ROOT_HOME/.bashrc  
echo "export PATH=\$PGHOME/bin:\$PATH" >>$ROOT_HOME/.bashrc  
echo "export LD_LIBRARY_PATH=\$PGHOME/lib:/usr/local/lib:/usr/lib/x86_64-linux-gnu:\$LD_LIBRARY_PATH" >>$ROOT_HOME/.bashrc  
echo "export PGDATA=/var/lib/postgresql/14/pgdata" >>$ROOT_HOME/.bashrc  
echo "export PGUSER=postgres" >>$ROOT_HOME/.bashrc  
echo "export PGHOST=\$PGDATA" >>$ROOT_HOME/.bashrc  
echo "export PGPORT=1921" >>$ROOT_HOME/.bashrc  
echo "export PGDATABASE=postgres" >>$ROOT_HOME/.bashrc  
echo "export LC_ALL=en_US.UTF-8" >>$ROOT_HOME/.bashrc  
. $ROOT_HOME/.bashrc  
  
export PG_HOME=/var/lib/postgresql  
echo "#  add by digoal" >>$PG_HOME/.bash_profile  
echo "alias rm='rm -i'" >>$PG_HOME/.bash_profile  
echo "alias cp='cp -i'" >>$PG_HOME/.bash_profile  
echo "alias ll='ls -larth'" >>$PG_HOME/.bash_profile  
echo "alias mv='mv -i'" >>$PG_HOME/.bash_profile  
echo "export PGHOME=/usr/lib/postgresql/14" >>$PG_HOME/.bash_profile  
echo "export PATH=\$PGHOME/bin:\$PATH" >>$PG_HOME/.bash_profile  
echo "export LD_LIBRARY_PATH=\$PGHOME/lib:/usr/local/lib:/usr/lib/x86_64-linux-gnu:\$LD_LIBRARY_PATH" >>$PG_HOME/.bash_profile  
echo "export PGDATA=/var/lib/postgresql/14/pgdata" >>$PG_HOME/.bash_profile  
echo "export PGUSER=postgres" >>$PG_HOME/.bash_profile  
echo "export PGHOST=\$PGDATA" >>$PG_HOME/.bash_profile  
echo "export PGPORT=1921" >>$PG_HOME/.bash_profile  
echo "export PGDATABASE=postgres" >>$PG_HOME/.bash_profile  
echo "export LC_ALL=en_US.UTF-8" >>$PG_HOME/.bash_profile  
  
echo ". ~/.bash_profile" > $PG_HOME/.profile  
chown postgres:postgres $PG_HOME/.bash_profile  
chown postgres:postgres $PG_HOME/.profile  
```  
  
```  
vi 3.sh  
```  
  
```  
#!/bin/bash  
set -vx  
  
export ROOT_HOME=/root  
. $ROOT_HOME/.bashrc  
  
export TEMP_DIR=/tmp  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/jaiminpan/pg_jieba  
cd $TEMP_DIR/pg_jieba  
git submodule update --init --recursive --depth 1  
mkdir build  
cd $TEMP_DIR/pg_jieba/build  
cmake -DPostgreSQL_TYPE_INCLUDE_DIR=/usr/include/postgresql/14/server ..  
make && make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/ChenHuajun/pg_roaringbitmap  
cd $TEMP_DIR/pg_roaringbitmap  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/theirix/parray_gin  
cd $TEMP_DIR/parray_gin  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/jirutka/smlar  
cd $TEMP_DIR/smlar  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/alitrack/duckdb_fdw  
cd $TEMP_DIR/duckdb_fdw  
# wget -T 36000 -t 0 --waitretry=5 https://github.com/duckdb/duckdb/releases/download/v0.9.0/libduckdb-linux-amd64.zip  
# curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L https://github.com/duckdb/duckdb/releases/download/v0.9.0/libduckdb-linux-amd64.zip -o libduckdb-linux-amd64.zip  
cp $TEMP_DIR/libduckdb-linux-amd64.zip $TEMP_DIR/duckdb_fdw/  
unzip -d . libduckdb-linux-amd64.zip  
cp libduckdb.so $(pg_config --libdir)  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/EnterpriseDB/hdfs_fdw  
cd $TEMP_DIR/hdfs_fdw/libhive  
JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64 JDK_INCLUDE=$JAVA_HOME/include INSTALL_DIR=/usr/lib/postgresql/14/lib PATH=/usr/lib/postgresql/14/bin:$PATH make  
JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64 JDK_INCLUDE=$JAVA_HOME/include INSTALL_DIR=/usr/lib/postgresql/14/lib PATH=/usr/lib/postgresql/14/bin:$PATH make install  
  
cd $TEMP_DIR/hdfs_fdw/libhive/jdbc  
javac MsgBuf.java  
javac HiveJdbcClient.java  
jar cf HiveJdbcClient-1.0.jar *.class  
cp HiveJdbcClient-1.0.jar /usr/lib/postgresql/14/lib  
  
cd $TEMP_DIR/hdfs_fdw  
JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64 JDK_INCLUDE=$JAVA_HOME/include INSTALL_DIR=/usr/lib/postgresql/14/lib PATH=/usr/lib/postgresql/14/bin:$PATH USE_PGXS=1 make  
JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64 JDK_INCLUDE=$JAVA_HOME/include INSTALL_DIR=/usr/lib/postgresql/14/lib PATH=/usr/lib/postgresql/14/bin:$PATH USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://gitlab.com/dalibo/postgresql_anonymizer.git  
cd $TEMP_DIR/postgresql_anonymizer  
make extension  
make install  
  
cd $TEMP_DIR  
git clone --depth 1 --branch stable https://github.com/jedisct1/libsodium  
cd $TEMP_DIR/libsodium  
./configure  
make  
make check  
make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/michelp/pgsodium  
cd $TEMP_DIR/pgsodium  
C_INCLUDE_PATH=/usr/include/postgresql/14/server PG_LDFLAGS=-L/usr/lib/postgresql/14/lib USE_PGXS=1 make  
C_INCLUDE_PATH=/usr/include/postgresql/14/server PG_LDFLAGS=-L/usr/lib/postgresql/14/lib USE_PGXS=1 make install  
  
cd $TEMP_DIR  
wget -T 36000 -t 0 --waitretry=5 https://github.com/libgd/libgd/archive/refs/tags/gd-2.3.3.tar.gz  
tar -zxvf gd-2.3.3.tar.gz  
cd $TEMP_DIR/libgd-gd-2.3.3  
mkdir build  
cd $TEMP_DIR/libgd-gd-2.3.3/build  
cmake ..  
make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/digoal/imgsmlr  
# git clone --depth 1 https://github.com/postgrespro/imgsmlr  
cd $TEMP_DIR/imgsmlr  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/postgrespro/vops  
cd $TEMP_DIR/vops  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 -b PG14 https://github.com/ossc-db/pg_hint_plan  
cd $TEMP_DIR/pg_hint_plan  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
apt-get install -y libselinux1-dev libpam0g-dev libkrb5-dev liblz4-dev  
git clone --depth 1 https://github.com/ossc-db/pg_bulkload  
cd $TEMP_DIR/pg_bulkload  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 -b 1.6.1 https://github.com/ossc-db/pg_store_plans  
cd $TEMP_DIR/pg_store_plans  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
# cd $TEMP_DIR  
# git clone --depth 1 -b REL-5_5_0 https://github.com/EnterpriseDB/mongo_fdw  
# cd $TEMP_DIR/mongo_fdw  
# ./autogen.sh --with-master  
# apt-get install -y libmongoc-dev  
# # C_INCLUDE_PATH="/include/libmongoc-1.0/mongoc:/include/libbson-1.0" USE_PGXS=1 make  
# # C_INCLUDE_PATH="/include/libmongoc-1.0/mongoc:/include/libbson-1.0" USE_PGXS=1 make install  
# USE_PGXS=1 make  
# USE_PGXS=1 make install

cd $TEMP_DIR  
git clone --depth 1 -b REL-5_5_1 https://github.com/EnterpriseDB/mongo_fdw  
cd $TEMP_DIR/mongo_fdw  
cp $TEMP_DIR/mongo-c-driver-1.17.3.tar.gz ./
tar -xzvf mongo-c-driver-1.17.3.tar.gz
rm -rf mongo-c-driver
mv mongo-c-driver-1.17.3 mongo-c-driver
cd $TEMP_DIR/mongo_fdw/mongo-c-driver
cmake -DENABLE_AUTOMATIC_INIT_AND_CLEANUP=OFF -DENABLE_SSL=AUTO .
make install 

cd $TEMP_DIR/mongo_fdw  
cp $TEMP_DIR/json-c-0.15-20200726.tar.gz ./ 
tar -xzvf json-c-0.15-20200726.tar.gz
rm -rf json-c
mv json-c-json-c-0.15-20200726 json-c
cd $TEMP_DIR/mongo_fdw/json-c
cmake .
make -j 2
make install

apt-get install -y libmongoc-dev  

cd $TEMP_DIR/mongo_fdw
echo "#ifdef __CONFIG__" >> config.h 
echo "#define META_DRIVER" >> config.h 
echo "#endif" >> config.h 
export PKG_CONFIG_PATH=mongo-c-driver/src/libmongoc/src:mongo-c-driver/src/libbson/src
mv Makefile Makefile.origin 
cp Makefile.meta Makefile 
# C_INCLUDE_PATH="/include/libmongoc-1.0/mongoc:/include/libbson-1.0" USE_PGXS=1 make  
# C_INCLUDE_PATH="/include/libmongoc-1.0/mongoc:/include/libbson-1.0" USE_PGXS=1 make install  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/neondatabase/neon  
cd $TEMP_DIR/neon/pgxn/hnsw  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
curl https://install.citusdata.com/community/deb.sh > add-citus-repo.sh  
bash add-citus-repo.sh  
apt-get install -y postgresql-14-citus-11.3  
  
cd $TEMP_DIR  
apt-get install -y libboost-all-dev  
wget -T 36000 -t 0 --waitretry=5 https://api.pgxn.org/dist/datasketches/1.6.0/datasketches-1.6.0.zip  
unzip datasketches-1.6.0.zip  
cd $TEMP_DIR/datasketches-1.6.0  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
# get GraphBLAS, compile with debug symbols  
# curl --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -s -L http://faculty.cse.tamu.edu/davis/GraphBLAS/GraphBLAS-3.1.1.tar.gz | tar zxvf - && cd GraphBLAS-3.1.1 && make library CMAKE_OPTIONS='-DCMAKE_BUILD_TYPE=Debug' && make install  
tar -zxvf GraphBLAS-3.1.1.tar.gz  
cd GraphBLAS-3.1.1  
make library CMAKE_OPTIONS='-DCMAKE_BUILD_TYPE=Debug'  
make install  
cd $TEMP_DIR  
git clone --depth 1 --branch 22July2019 https://github.com/GraphBLAS/LAGraph.git && cd LAGraph && make -j4 library && make install  
cd $TEMP_DIR  
curl --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -s -L https://github.com/theory/pgtap/archive/v0.99.0.tar.gz | tar zxvf - && cd pgtap-0.99.0 && make -j4 && make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/michelp/pggraphblas  
cd $TEMP_DIR/pggraphblas  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 -b REL1_2_STABLE https://github.com/pgbigm/pg_bigm  
cd $TEMP_DIR/pg_bigm  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/percona/pg_stat_monitor  
cd $TEMP_DIR/pg_stat_monitor  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/neondatabase/pg_embedding  
cd $TEMP_DIR/pg_embedding  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/cybertec-postgresql/pgfaceting  
cd $TEMP_DIR/pgfaceting  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/pgexperts/pg_plan_filter  
cd $TEMP_DIR/pg_plan_filter  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/postgrespro/pg_variables  
cd $TEMP_DIR/pg_variables  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
apt-get install -y libcurl-ocaml-dev  
wget -T 36000 -t 0 --waitretry=5 https://api.pgxn.org/dist/pg_curl/2.1.1/pg_curl-2.1.1.zip  
unzip pg_curl-2.1.1.zip  
cd $TEMP_DIR/pg_curl-2.1.1  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
apt-get install -y systemtap-sdt-dev  
# git clone --depth 1 https://github.com/RekGRpth/pg_task  
# cd $TEMP_DIR/pg_task  
# USE_PGXS=1 make install
pgxn install pg_task 
# wget -T 36000 -t 0 --waitretry=5 https://api.pgxn.org/dist/pg_task/2.0.41/pg_task-2.0.41.zip  
# unzip pg_task-2.0.41.zip  
# cd $TEMP_DIR/pg_task-2.0.41  
# USE_PGXS=1 make install  
  
cd $TEMP_DIR  
wget -T 36000 -t 0 --waitretry=5 https://api.pgxn.org/dist/temporal_tables/1.2.1/temporal_tables-1.2.1.zip  
unzip temporal_tables-1.2.1.zip  
cd $TEMP_DIR/temporal_tables-1.2.1  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 -b v2.10 https://github.com/darold/pgtt  
cd $TEMP_DIR/pgtt  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
wget -T 36000 -t 0 --waitretry=5 https://api.pgxn.org/dist/pg_query_rewrite/0.0.5/pg_query_rewrite-0.0.5.zip  
unzip pg_query_rewrite-0.0.5.zip  
cd $TEMP_DIR/pg_query_rewrite-0.0.5  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
wget -T 36000 -t 0 --waitretry=5 https://api.pgxn.org/dist/pg_track_settings/2.1.2/pg_track_settings-2.1.2.zip  
unzip pg_track_settings-2.1.2.zip  
cd $TEMP_DIR/pg_track_settings-2.1.2  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
wget -T 36000 -t 0 --waitretry=5 https://api.pgxn.org/dist/aggs_for_vecs/1.3.0/aggs_for_vecs-1.3.0.zip  
unzip aggs_for_vecs-1.3.0.zip  
cd $TEMP_DIR/aggs_for_vecs-1.3.0  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
wget -T 36000 -t 0 --waitretry=5 https://api.pgxn.org/dist/quantile/1.1.7/quantile-1.1.7.zip  
unzip quantile-1.1.7.zip  
cd $TEMP_DIR/quantile-1.1.7  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
wget -T 36000 -t 0 --waitretry=5 https://api.pgxn.org/dist/pg_utility_trigger_functions/1.8.0/pg_utility_trigger_functions-1.8.0.zip  
unzip pg_utility_trigger_functions-1.8.0.zip  
cd $TEMP_DIR/pg_utility_trigger_functions-1.8.0  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
wget -T 36000 -t 0 --waitretry=5 https://api.pgxn.org/dist/pg_safer_settings/0.8.10/pg_safer_settings-0.8.10.zip  
unzip pg_safer_settings-0.8.10.zip  
cd $TEMP_DIR/pg_safer_settings-0.8.10  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
wget -T 36000 -t 0 --waitretry=5 https://api.pgxn.org/dist/ddlx/0.23.0/ddlx-0.23.0.zip  
unzip ddlx-0.23.0.zip  
cd $TEMP_DIR/ddlx-0.23.0  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 -b REL14_0 https://github.com/ossc-db/pg_dbms_stats  
cd $TEMP_DIR/pg_dbms_stats  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
apt-get install -y libzlcore-dev  
git clone --depth 1 -b REL_14_STABLE https://github.com/ossc-db/pg_rman  
cd $TEMP_DIR/pg_rman  
make install  
  
cd $TEMP_DIR  
git clone --depth 1 git://sigaev.ru/online_analyze  
cd $TEMP_DIR/online_analyze/  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 git://sigaev.ru/plantuner  
cd $TEMP_DIR/plantuner/  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/digoal/gevel  
cd $TEMP_DIR/gevel  
. ./install.sh  
  
cd $TEMP_DIR  
git clone --depth 1 -b 4.2 https://github.com/zubkov-andrei/pg_profile  
cd $TEMP_DIR/pg_profile  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
# git clone --depth 1 https://github.com/s-hironobu/pg_plan_inspector  
# cd $TEMP_DIR/pg_plan_inspector
# bug 修复之前 :  https://github.com/s-hironobu/pg_plan_inspector/issues/1 
git clone https://github.com/s-hironobu/pg_plan_inspector  
cd $TEMP_DIR/pg_plan_inspector  
git checkout fa845045ed5a776779f2d5308608ac18ed045aad
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
# apt-get install -y libhealpix-cxx-dev  
# cd $TEMP_DIR  
# git clone --depth 1 -b 1.2.3 https://github.com/postgrespro/pgsphere  
# cd $TEMP_DIR/pgsphere  
# USE_PGXS=1 make  
# USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/sraoss/pg_ivm  
cd $TEMP_DIR/pg_ivm  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/pgvector/pgvector  
cd $TEMP_DIR/pgvector  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth=1 https://github.com/vyruss/pg_statviz.git  
cd $TEMP_DIR/pg_statviz  
USE_PGXS=1 make install  
  
apt-get install -y python3-pip  
pip install pg_statviz  
  
cd $TEMP_DIR  
# curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L https://github.com/Kitware/CMake/releases/download/v3.27.4/cmake-3.27.4.tar.gz -o cmake-3.27.4.tar.gz  
tar -zxvf cmake-3.27.4.tar.gz  
cd $TEMP_DIR/cmake-3.27.4  
env CC=clang CXX=clang++ ./bootstrap -- -DCMAKE_BUILD_TYPE:STRING=Release  
make -j2  
make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/zachasme/h3-pg  
cd $TEMP_DIR/h3-pg  
USE_PGXS=1 make all  
USE_PGXS=1 make install  
  
  
export RUSTUP_DIST_SERVER=https://mirrors.ustc.edu.cn/rust-static  
export RUSTUP_UPDATE_ROOT=https://mirrors.ustc.edu.cn/rust-static/rustup  
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs -o ./rust.sh  
chmod 500 rust.sh  
./rust.sh -y  
source "$HOME/.cargo/env"  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/postgresml/pgcat  
cd $TEMP_DIR/pgcat  
cargo build --release  
  
# cd $TEMP_DIR  
# git clone --depth 1 https://github.com/tembo-io/pg_later  
# https://github.com/tembo-io/pg_later/blob/main/CONTRIBUTING.md  
# cd $TEMP_DIR/pg_later  
# cargo build --release

cd $TEMP_DIR
git clone --depth 1 https://github.com/chimpler/postgres-aws-s3
cd $TEMP_DIR/postgres-aws-s3
USE_PGXS=1 make install

cd $TEMP_DIR
git clone --depth 1 -b PG14 https://github.com/apache/age
cd $TEMP_DIR/age
USE_PGXS=1 make
USE_PGXS=1 make install

apt-get install -y npm 
# cd $TEMP_DIR
# tar -zxvf node-v14.21.3.tar.gz
# cd node-v14.21.3
# ./configure
# CC=clang CXX=clang++ make -j 4
# CC=clang CXX=clang++ make install 
npm i pm2
cd $TEMP_DIR
git clone --depth 1 https://github.com/apache/age-viewer
cd $TEMP_DIR/age-viewer
npm run setup

cd $TEMP_DIR 
git clone --depth 1 https://github.com/michelp/pgjwt
cd $TEMP_DIR/pgjwt 
USE_PGXS=1 make install

cd $TEMP_DIR
git clone --depth 1 https://github.com/supabase/pg_net
cd $TEMP_DIR/pg_net
USE_PGXS=1 make install

cd $TEMP_DIR
wget -q -O - http://www.xunsearch.com/scws/down/scws-1.2.3.tar.bz2 | tar jxf -
cd $TEMP_DIR/scws-1.2.3 
./configure 
make install 

cd $TEMP_DIR
git clone --depth 1 https://github.com/amutu/zhparser.git
cd $TEMP_DIR/zhparser 
PG_CONFIG=/usr/lib/postgresql/14/bin/pg_config make && make install

cd $TEMP_DIR
git clone --depth 1 https://github.com/pramsey/pgsql-http
cd $TEMP_DIR/pgsql-http
USE_PGXS=1 make install

cd $TEMP_DIR
git clone --depth 1 https://github.com/pgsentinel/pgsentinel
cd $TEMP_DIR/pgsentinel/src
USE_PGXS=1 make install

cd $TEMP_DIR
git clone --depth 1 https://github.com/postgrespro/zson
cd $TEMP_DIR/zson
USE_PGXS=1 make install

cd $TEMP_DIR
cp pg_tiktoken--0.0.1.sql /usr/share/postgresql/14/extension/
cp pg_tiktoken.control /usr/share/postgresql/14/extension/
cp pg_tiktoken.so /usr/lib/postgresql/14/lib/

cd $TEMP_DIR 
git clone --depth 1 --recursive https://github.com/lanterndata/lantern.git
cd $TEMP_DIR/lantern
mkdir build
cd $TEMP_DIR/lantern/build
cmake ..
make install

cd $TEMP_DIR
cp lantern_extras--0.0.1.sql /usr/share/postgresql/14/extension/
cp lantern_extras.control /usr/share/postgresql/14/extension/
cp lantern_extras.so /usr/lib/postgresql/14/lib/
cp lantern-create-index /var/lib/postgresql/
chown postgres:postgres /var/lib/postgresql/lantern-create-index
   
cd $TEMP_DIR
git clone --depth 1 -b v1.0.0 https://github.com/hydradatabase/hydra
cd $TEMP_DIR/hydra/columnar
./configure
USE_PGXS=1 make install
  
cd $TEMP_DIR
mkdir -p /usr/local/onnxruntime
tar vzxf onnxruntime-linux-x64-1.15.1.tgz -C /usr/local/onnxruntime --strip-components=1
echo "/usr/local/onnxruntime/lib" > /etc/ld.so.conf.d/onnxruntime.conf
ldconfig

cd $TEMP_DIR
git clone --depth 1 -b 35-v121-compile-error https://github.com/kibae/onnxruntime-server
cd $TEMP_DIR/onnxruntime-server
cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
cmake --build build --parallel 4
cmake --install build --prefix /usr/local/onnxruntime-server

cd $TEMP_DIR
git clone --depth 1 -b v1.15.1 https://github.com/microsoft/onnxruntime
cp /tmp/onnxruntime/include/onnxruntime/core/session/* /usr/local/onnxruntime/

cd $TEMP_DIR
git clone --depth 1 --recursive https://github.com/kibae/pg_onnx.git
cd $TEMP_DIR/pg_onnx
cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
cmake --build build --target pg_onnx --parallel 4 
cmake --install build/pg_onnx
  
cd $TEMP_DIR
curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | bash
apt-get install -y git-lfs
  
cd $TEMP_DIR
GIT_LFS_SKIP_SMUDGE=1 git clone --depth 1 https://github.com/onnx/models
cd $TEMP_DIR/models
git lfs install

cd $TEMP_DIR
git clone --depth 1 https://github.com/fboulnois/pg_uuidv7
cd $TEMP_DIR/pg_uuidv7
USE_PGXS=1 make install

apt-get install -y libcurl4-openssl-dev uuid-dev libpulse-dev 
cd $TEMP_DIR
git clone --depth 1 -b apache-arrow-12.0.1 https://github.com/apache/arrow.git  
cd $TEMP_DIR/arrow/cpp  
mkdir build-release  
cd $TEMP_DIR/arrow/cpp/build-release  
# cmake -DARROW_DEPENDENCY_SOURCE=BUNDLED -DARROW_PARQUET=ON -DARROW_ORC=ON -DARROW_S3=ON -DARROW_WITH_LZ4=ON -DARROW_WITH_SNAPPY=ON -DARROW_WITH_ZLIB=ON -DARROW_WITH_ZSTD=ON -DPARQUET_REQUIRE_ENCRYPTION=ON  ..
cmake -DARROW_DEPENDENCY_SOURCE=BUNDLED -DARROW_PARQUET=ON .. 
make -j4  
make install  
ldconfig 

cd $TEMP_DIR
git clone --depth 1 https://github.com/adjust/parquet_fdw 
cd $TEMP_DIR/parquet_fdw
make install 
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/pgspider/sqlite_fdw
cd $TEMP_DIR/sqlite_fdw
USE_PGXS=1 make  
USE_PGXS=1 make install
  
cd $TEMP_DIR  
git clone --depth 1 -b 14.2 https://github.com/ossc-db/pg_statsinfo  
cd $TEMP_DIR/pg_statsinfo  
PG_LDFLAGS=-L/usr/lib/postgresql/14/lib make  
PG_LDFLAGS=-L/usr/lib/postgresql/14/lib make install  
  
cd /usr/lib/postgresql/14  
git clone --depth 1 -b 14.0 https://github.com/ossc-db/pg_stats_reporter  
  
cd /usr/lib/postgresql/14  
git clone --depth 1 https://github.com/swida/sqlbench  
cd /usr/lib/postgresql/14/sqlbench  
autoreconf -if  
./configure --with-postgresql="$PGHOME"  
C_INCLUDE_PATH=/usr/include/postgresql make  
C_INCLUDE_PATH=/usr/include/postgresql make install  
  
apt-get install -y libpcap-dev libnl-genl-3-dev  
cd /tmp  
git clone --depth 1 -b 8.4.0-stable https://github.com/ntop/PF_RING  
cd /tmp/PF_RING/userland/lib  
./configure && make  
make install  
cd /tmp  
git clone --depth 1 https://github.com/heterodb/pg-strom  
cd /tmp/pg-strom/arrow-tools  
PG_CONFIG=/usr/lib/postgresql/14/bin/pg_config C_INCLUDE_PATH=/tmp/PF_RING/kernel make  
PG_CONFIG=/usr/lib/postgresql/14/bin/pg_config C_INCLUDE_PATH=/tmp/PF_RING/kernel make install  
  
cd /usr/lib/postgresql/14  
git clone --depth 1 https://github.com/apache/madlib  
cd /usr/lib/postgresql/14/madlib  
mkdir build  
cd /usr/lib/postgresql/14/madlib/build  
cmake ..  
make -j 4  
# $BUILD_ROOT/src/bin/madpack -s madlib -p postgres -c [user[/password]@][host][:port][/database] install  
```  
  
```  
vi 4.sh  
```  
  
```  
#!/bin/bash  
set -vx  
  
echo "* soft    nofile  1024000" >> /etc/security/limits.conf  
echo "* hard    nofile  1024000" >> /etc/security/limits.conf  
echo "* soft    nproc   unlimited" >> /etc/security/limits.conf  
echo "* hard    nproc   unlimited" >> /etc/security/limits.conf  
echo "* soft    core    unlimited" >> /etc/security/limits.conf  
echo "* hard    core    unlimited" >> /etc/security/limits.conf  
echo "* soft    memlock unlimited" >> /etc/security/limits.conf  
echo "* hard    memlock unlimited" >> /etc/security/limits.conf  
```  
  
```  
vi 5.sh  
```  
  
```  
#!/bin/bash  
set -vx  
  
export PG_HOME=/var/lib/postgresql  
. $PG_HOME/.bash_profile  
initdb -D $PGDATA -U postgres -E UTF8 --lc-collate=C --lc-ctype=en_US.UTF8  
  
cd $PGDATA  
echo "host all all 0.0.0.0/0 scram-sha-256" >> ./pg_hba.conf  
  
echo "listen_addresses = '0.0.0.0'" >> ./postgresql.auto.conf		  
echo "port = 1921" >> ./postgresql.auto.conf				  
echo "max_connections = 2000" >> ./postgresql.auto.conf			  
echo "unix_socket_directories = '., /var/run/postgresql'" >> ./postgresql.auto.conf	  
echo "shared_buffers = 128MB" >> ./postgresql.auto.conf			  
echo "dynamic_shared_memory_type = posix" >> ./postgresql.auto.conf	  
echo "vacuum_cost_delay = 0" >> ./postgresql.auto.conf			  
echo "bgwriter_delay = 20ms" >> ./postgresql.auto.conf			  
echo "bgwriter_lru_maxpages = 500" >> ./postgresql.auto.conf		  
echo "bgwriter_lru_multiplier = 5.0" >> ./postgresql.auto.conf		  
echo "max_parallel_workers_per_gather = 0" >> ./postgresql.auto.conf	  
echo "synchronous_commit = off" >> ./postgresql.auto.conf		  
echo "wal_compression = on" >> ./postgresql.auto.conf		  
echo "wal_writer_delay = 10ms" >> ./postgresql.auto.conf		  
echo "max_wal_size = 1GB " >> ./postgresql.auto.conf  
echo "min_wal_size = 80MB " >> ./postgresql.auto.conf  
echo "random_page_cost = 1.1" >> ./postgresql.auto.conf			  
echo "log_destination = 'csvlog'" >> ./postgresql.auto.conf		  
echo "logging_collector = on" >> ./postgresql.auto.conf		  
echo "log_truncate_on_rotation = on" >> ./postgresql.auto.conf		  
echo "log_timezone = 'Etc/UTC' " >> ./postgresql.auto.conf  
echo "autovacuum = on" >> ./postgresql.auto.conf			  
echo "autovacuum_vacuum_cost_delay = 0ms" >> ./postgresql.auto.conf	  
echo "vacuum_freeze_table_age = 750000000 " >> ./postgresql.auto.conf  
echo "vacuum_multixact_freeze_table_age = 750000000 " >> ./postgresql.auto.conf  
echo "datestyle = 'iso, mdy' " >> ./postgresql.auto.conf  
echo "timezone = 'Etc/UTC' " >> ./postgresql.auto.conf  
echo "lc_messages = 'en_US.UTF-8'" >> ./postgresql.auto.conf			  
echo "lc_monetary = 'en_US.UTF-8'" >> ./postgresql.auto.conf			  
echo "lc_numeric = 'en_US.UTF-8'" >> ./postgresql.auto.conf			  
echo "lc_time = 'en_US.UTF-8'" >> ./postgresql.auto.conf				  
echo "default_text_search_config = 'pg_catalog.english'" >> ./postgresql.auto.conf  
```  
  
  
  
  
4、准备Dockerfile  
  
```  
cd ~/pg14  
  
vi Dockerfile  
```  
  
```  
FROM --platform=$TARGETPLATFORM debian:11.7  
MAINTAINER digoal zhou "dege.zzz@alibaba-inc.com"  
ARG TARGETPLATFORM  
ARG BUILDPLATFORM  
RUN echo "I am running on $BUILDPLATFORM, building for $TARGETPLATFORM"  
ENV DEBIAN_FRONTEND=noninteractive TEMP_DIR=/tmp ROOT_HOME=/root PG_HOME=/var/lib/postgresql PG_DATA=/var/lib/postgresql/14/pgdata PGHOME=/usr/lib/postgresql/14  
STOPSIGNAL SIGINT  
COPY --chmod=555 1.sh 2.sh 3.sh 4.sh 5.sh $TEMP_DIR/  
COPY GraphBLAS-3.1.1.tar.gz libduckdb-linux-amd64.zip duckdb_cli-linux-amd64.zip cmake-3.27.4.tar.gz mongo-c-driver-1.17.3.tar.gz json-c-0.15-20200726.tar.gz pg_tiktoken--0.0.1.sql pg_tiktoken.control pg_tiktoken.so lantern_extras--0.0.1.sql lantern_extras.control lantern_extras.so lantern-create-index onnxruntime-linux-x64-1.15.1.tgz node-v14.21.3.tar.gz $TEMP_DIR/
 
  
RUN $TEMP_DIR/1.sh  
RUN $TEMP_DIR/2.sh  
RUN $TEMP_DIR/3.sh  
  
# WORKDIR $TEMP_DIR  
# RUN apt install -y libtinfo5 build-essential ninja-build python3  
# RUN git clone --depth 1 -b v3.1.7 https://github.com/plv8/plv8  
# WORKDIR $TEMP_DIR/plv8  
# RUN USE_ICU=1 USE_PGXS=1 make  
# RUN USE_ICU=1 USE_PGXS=1 make install  
#  
# WORKDIR $TEMP_DIR  
# RUN git clone --depth 1 -b apache-arrow-12.0.1 https://github.com/apache/arrow.git  
# WORKDIR $TEMP_DIR/arrow/cpp  
# RUN mkdir build-release  
# WORKDIR $TEMP_DIR/arrow/cpp/build-release  
# RUN cmake -DARROW_DEPENDENCY_SOURCE=BUNDLED ..  
# RUN make -j4  
# RUN make install  
#  
# WORKDIR $TEMP_DIR  
# RUN apt install -y libcurl4-openssl-dev uuid-dev libpulse-dev  
# RUN git clone --depth 1 -b 1.9.263 https://github.com/aws/aws-sdk-cpp  
# WORKDIR $TEMP_DIR/aws-sdk-cpp  
# RUN git submodule update --init --recursive --depth 1  
# RUN mkdir build  
# WORKDIR $TEMP_DIR/aws-sdk-cpp/build  
# RUN cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_ONLY="s3;core"  
# RUN make -j4  
# RUN make install  
#  
# WORKDIR $TEMP_DIR  
# RUN git clone --depth 1 -b v1.0.0 https://github.com/pgspider/parquet_s3_fdw  
# WORKDIR $TEMP_DIR/parquet_s3_fdw  
# RUN PG_CPPFLAGS="-Wno-register -D_GLIBCXX_USE_CXX11_ABI=0" USE_PGXS=1 make  
# RUN PG_CPPFLAGS="-std=c++17 -Wno-register -D_GLIBCXX_USE_CXX11_ABI=0" USE_PGXS=1 make  
# RUN PG_CPPFLAGS="-std=c++17 -Wno-register -D_GLIBCXX_USE_CXX11_ABI=0" USE_PGXS=1 make install  
# RUN echo "/usr/local/lib" >>/etc/ld.so.conf  
# RUN ldconfig  
  
  
ENV ORACLE_BASE /usr/lib/postgresql/14/lib  
WORKDIR $ORACLE_BASE  
COPY instantclient_12_2/libclntsh.so.12.1 .  
RUN ln -s libclntsh.so.12.1 libclntsh.so  
RUN mkdir -p oracle/network/admin  
COPY instantclient_12_2 ./oracle  
RUN echo "export LD_LIBRARY_PATH=\$PGHOME/lib/oracle:\$LD_LIBRARY_PATH" >>$PG_HOME/.bash_profile  
RUN echo "export ORACLE_HOME=\$PGHOME/lib/oracle" >>$PG_HOME/.bash_profile  
RUN echo "export TNS_ADMIN=\$ORACLE_HOME/network/admin/" >>$PG_HOME/.bash_profile  
RUN echo "export LD_LIBRARY_PATH=\$PGHOME/lib/oracle:\$LD_LIBRARY_PATH" >>$ROOT_HOME/.bashrc  
RUN echo "export ORACLE_HOME=\$PGHOME/lib/oracle" >>$ROOT_HOME/.bashrc  
RUN echo "export TNS_ADMIN=\$ORACLE_HOME/network/admin/" >>$ROOT_HOME/.bashrc  
RUN . $ROOT_HOME/.bashrc  
  
RUN echo "/usr/lib/postgresql/14/lib/oracle" >> /etc/ld.so.conf  
RUN echo "/usr/local/lib" >> /etc/ld.so.conf  
RUN echo "/usr/lib/postgresql/14/lib" >> /etc/ld.so.conf  
RUN ldconfig  
  
WORKDIR $TEMP_DIR  
RUN apt install -y libsqlite3-dev  
RUN git clone --depth 1 https://github.com/ossc-db/dblink_plus  
WORKDIR $TEMP_DIR/dblink_plus  
RUN cp -r /usr/lib/postgresql/14/lib/oracle/sdk/include/* ./  
RUN PG_CFLAGS=-I/usr/lib/postgresql/14/lib/oracle/sdk/include PG_LDFLAGS=-L/usr/lib/postgresql/14/lib/oracle USE_PGXS=1 make  
RUN PG_CFLAGS=-I/usr/lib/postgresql/14/lib/oracle/sdk/include PG_LDFLAGS=-L/usr/lib/postgresql/14/lib/oracle USE_PGXS=1 make install  
  
# RUN rm -rf $TEMP_DIR/*  
  
RUN $TEMP_DIR/4.sh  
  
USER postgres  
RUN $TEMP_DIR/5.sh
  
WORKDIR $PG_HOME  
# RUN wget -T 36000 -t 0 --waitretry=5 https://github.com/duckdb/duckdb/releases/download/v0.9.0/duckdb_cli-linux-amd64.zip  
# RUN curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L https://github.com/duckdb/duckdb/releases/download/v0.9.0/duckdb_cli-linux-amd64.zip -o duckdb_cli-linux-amd64.zip  
RUN cp $TEMP_DIR/duckdb_cli-linux-amd64.zip $PG_HOME/  
RUN unzip -d . duckdb_cli-linux-amd64.zip  
  
USER root  
WORKDIR $ROOT_HOME  

EXPOSE 1921
EXPOSE 3000 
ENTRYPOINT ["su", "-", "postgres", "-c", "/usr/lib/postgresql/14/bin/postgres -D \"/var/lib/postgresql/14/pgdata\""]  
```  
  
5、配置ignore文件  
  
```  
cd ~/pg14  
mkdir logs  
  
vi .dockerignore  
logs/  
```  
  
6、制作镜像  
  
6\.1、确认已开启docker 实验属性: `"experimental": true` .  在docker desktop setting: docker engine中配置.  例如:  
```  
{  
  "builder": {  
    "gc": {  
      "defaultKeepStorage": "20GB",  
      "enabled": true  
    }  
  },  
  "dns": [  
    "8.8.8.8"  
  ],  
  "experimental": true,  
  "registry-mirrors": [  
    "https://xxxxxxx.mirror.aliyuncs.com"  
  ]  
}  
```  
  
下载debian amd64架构基础镜像  
  
```  
docker pull --platform=linux/amd64 debian:11.7  
```  
  
确认下载的debian 基础镜像 架构符合预期: amd64  
  
```  
当前打包镜像的是macbook m2芯片机器:  
  U-4G77XXWF-1921:pg14 digoal$ arch  
  arm64  
  
下载的debian 基础镜像 架构符合预期: amd64 , 因为我们目标是打包x86_64(amd64)的镜像  
  U-4G77XXWF-1921:pg14 digoal$ docker image inspect debian:11.7|grep Architecture  
          "Architecture": "amd64",  
```  
  
6\.2、制作postgresql 14镜像:  
  
```  
cd ~/pg14  
  
docker build --platform=linux/amd64 -t="digoal/pg14:with_exts_amd64" . 2>&1 | tee ./logs/build.log  
  
# docker build --platform=linux/amd64 -t="digoal/pg14:with_exts_amd64" --no-cache . 2>&1 | tee ./logs/build.log  
```  
  
仔细检查是否有错误并解决, 例如:  
  
```  
grep Error ./logs/build.log  
grep -i fail ./logs/build.log  
grep -i fatal ./logs/build.log  
grep ERROR ./logs/build.log
grep "ERR\!" ./logs/build.log
grep "E: " logs/build.log  
grep error ./logs/build.log | grep -v "\-Werror"  
```  
  
修复问题后, 可以使用build好的镜像启动容器测试.  
  
```  
docker run --platform=linux/amd64 -d -it -P --cap-add=SYS_PTRACE --cap-add SYS_ADMIN --privileged=true --name pg --shm-size=1g digoal/pg14:with_exts_amd64  
  
docker exec -ti pg bash  
  
psql  
```  
  
7、推送镜像到阿里云个人镜像服务, 参考:  
- [《制作PolarDB | PostgreSQL 开源docker镜像, 集成大量插件方便学习, 并推送到阿里云镜像服务》](../202307/20230710_02.md)  
  
7\.1、 将镜像推送到Registry  
  
```  
docker login --username=dig***@126.com registry.cn-hangzhou.aliyuncs.com  
docker images  
docker tag [ImageId] registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:[镜像版本号]  
docker push registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:[镜像版本号]  
```  
  
根据实际镜像信息替换示例中的`[ImageId]`和`[镜像版本号]`参数。 例如:  
  
```  
docker tag [ImageId] registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pg14_with_exts  
docker push registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pg14_with_exts  
```  
  
7\.2、 拉取image不需要login  
  
```  
docker pull registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pg14_with_exts  
```  
  
加platform参数启动容器:  
```  
docker run --platform linux/amd64 -d -it -P --cap-add=SYS_PTRACE --cap-add SYS_ADMIN --privileged=true --name pg --shm-size=1g registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pg14_with_exts  
  
-- 也可以在打包镜像的时候指定多平台, 具体请参考docker 文档.  
-- docker buildx build --platform=linux/amd64,linux/arm64 -t="digoal/pg14:with_exts" . 2>&1 | tee ./logs/build.log  
```  
  
## 集成了哪些插件?  
插件的详细功能和用法请参考:  
- [《未来数据库方向 - 以及PostgreSQL 有价值的插件、可改进功能、开放接口 (202005)》](../202005/20200527_06.md)  
  
1、PG 14自带的所有插件.  
  
2、额外安装的插件或工具  
  
类型增强
- pgmp, PostgreSQL Multiple Precision Arithmetic extension, 支持GMP library, 高性能表达decimal类型.
- unit, 支持很多国际单位的类型
- pg_uuidv7, A tiny Postgres extension to create version 7 UUIDs  
  
函数增强  
- extra-window-functions, 扩展窗口函数  
- first-last-agg, 扩展聚合函数  
- tdigest, 扩展窗口、聚合函数  
- rational, 扩展插值算法和函数  
- orafce, 扩展Oracle兼容性  
- aggs_for_vecs, 数组类型聚合函数扩展.  
- quantile, 统计分析相关聚合函数扩展.
- pgjwt, JSON 值转储格式: JSON Web Tokens
  
近似统计分析  
- hll, 近似分析, 例如滑动窗口UV, 短视频场景存储已读列表+快速过滤已读视频  
- datasketches, 近似统计算法库  
  
标签圈选  
- smlar, 标签相似搜索  
- roaringbitmap, 标签圈选  
- pgfaceting, 基于rb index的快速降维分析插件(例如任意条件的UV分析, 滑动窗口分析等)  
  
存储引擎、分析加强:  
- citus, 分布式和列存储  
- columnar, Hydra Columnar extension. 列存储引擎. 
- vops, 瓦片存储和向量化计算  
- orioledb, 基于UNDO机制的存储引擎.    (未集成.)  
- zedstore, 行列混合存储引擎.          (未集成.)  
- pg_cryogen, appendonly的压缩存储引擎.   (未集成.)  
- pg_ivm, 增量刷新物化视图  
  
多值列索引扩展加速  
- rum, 多值列+标量复合搜索加速  
- parray_gin, 多值列元素值模糊搜索  
  
多模型业务场景  
- rdkit, 化学类型+算法+索引  
- timescaledb, 时序  
- pggraphblas, 图式关系加速搜索  
- age, 图式关系搜索(兼容cypherQL语法).    
- madlib, 机器学习分析库  
- pg_variables, 会话或事务级内存变量, 例如用于计数器、需要在会话|事务中存储临时值的场景.  
- temporal_tables, 自动按字段时间归档历史数据.  
- pgtt, 全局临时表, 类似Oracle 全局临时表的风格.  
  
空间业务场景  
- pgrouting, 路由算法  
- pgrouting-doc  
- pgrouting-scripts  
- pgsphere, 空间类型+索引  
- pointcloud, 点云  
- q3c, 空间类型+索引  
- postgis-3, 丰富的空间类型+算法+函数接口+索引  
- postgis-3-scripts  
- ip4r, IP转地理位置信息  
- h3, h3_postgis, uber开源的基于H3模型的地图相关插件.  
  
向量搜索  
- similarity, 近似算法, 类型+索引  
- imgsmlr, 图像搜索, 类型+索引  
- pgvector, 向量搜索, 类型+索引(ivfflat、hnsw)  
- hnsw, 向量搜索, 类型+索引(hnsw)  
- pg_embedding, 向量搜索, 类型+索引(hnsw)  
- lantern, 向量搜索, 类型+索引(usearch implemented hnsw)
- lantern_extras, lantern辅助插件: 数据库内置大模型, 外接大模型, 文本|图像向量化, 加速向量索引build等. 
  
文本场景增强  
- prefix, 前缀范围模型  
- groonga, 支持wchar的任意模糊搜索  
- pg_bigm, 增强pg_trgm模糊搜索  
- pg_jieba, 结巴中文分词
- zhparser, scws中文分词
  
数据融合, 冷热分离  
- mongo_fdw, 读写mongo数据源  
- parquet_s3_fdw, 读写s3,oss对象存储和parquet文件.  (未集成, 通过duckdb_fdw可以读写s3, aliyun oss, 更加快捷)  
- mysql-fdw, 读写mysql数据源  
- ogr-fdw, 基于ogr的通用数据源读写插件  
- oracle-fdw, 读写oracle数据源  
- tds-fdw, 读写ms sql数据源  
- dblink_plus, mysql,sqlite3,oracle的dblink  
- duckdb_fdw, 读写duckdb数据源. 通过duckdb_fdw还可以读写存放在s3的csv, parquet文件. 
- parquet_fdw, 读parquet文件. 
- hdfs_fdw, 读写hive, spark数据源  
- pgmemcache, 直接的memcache控制函数库  
- pg_curl, 通过curl支持http,ftp,https等网络协议. 将远程数据加载到数据库中.
- pg_net, 异步HTTP调用接口.
- pgsql-http, HTTP 调用接口.
- pg2arrow , 将pg sql结果转换为arrow格式的数据文件. 适合与其他arrow生态的数据分析产品、DB交换数据, 融入大数据生态, 加速数据分析.
- aws_s3, 读写aws s3对象存储.
- decoderbufs, 逻辑复制decoding, logical decoder output plugin to deliver data as Protocol Buffers
  
扩展协议, 兼容其他产品
- FerretDB, 支持mongodb协议, 可使用mongodb客户端连接. (未集成)
- babelfish, 支持sql server协议, 可使用sqlserver客户端连接. (未集成)
- Apache Arrow Flight SQL adapter, arrow 协议, 可使用arrow driver连接. (未集成, 需PG 15及以上版本.)
  
存储过程和函数语言增强  
- jsquery, 增强json语法查询库  
- pldebugger, 调试plpgsql函数  
- plpgsql-check, 预检查plpgsql函数  
- pljava, java存储过程和函数语言  
- pllua, lua存储过程和函数语言  
- plproxy, 代理(通常用于sharding和并行数据聚合访问场景)  
- plv8, google v8存储过程和函数语言.    (未集成, 未来可以通过apt安装)  
- plpython3, python存储过程和函数语言  
- plr, R存储过程和函数语言  
- plprofiler, 存储过程和函数的性能分析功能  
  
安全增强  
- postgresql_anonymizer, 敏感信息遮蔽  
- pgsodium, 敏感信息遮蔽以及sodium加密库函数
- credcheck, 强制约束用户密码复杂度
  
数据库管理、审计、性能优化等  
- powa, 索引推荐, 等待事件分析, 命中率, 配置变更跟踪等  
- hypopg, 虚拟索引, 索引推荐  
- pg-qualstats, 索引推荐  
- pg-stat-kcache, 跟踪cpu、文件系统真实读写行为  
- pg-wait-sampling, 等待事件采样分析  
- show-plans, 执行过程中的SQL执行计划查询  
- pg_hint_plan, 强制设定SQL执行计划  
- plantuner, 增加了一些参数用来控制SQL执行计划  
- pg_store_plans, 保存SQL执行计划  
- pg_plan_inspector, 复杂SQL执行计划优化修正插. 使用机器学习的方法对收集到的SQL和执行计划等信息进行分析, 从而提升性能.  通过sql安装, 没有extension control file
- pg_stat_monitor, 保存数据库运行时统计信息快照, 用于分析性能  
- pg_statviz, 保存统计信息快照, 使用matplotlib绘图.  
- pg_profile, 使用pg_stat_statements, pg_stat_kcache的统计信息打快照并对快照进行分析. 类似[awr](https://zubkov-andrei.github.io/pg_profile/report_examples/pg15.html). 不过我觉得perf insight和pg_stat_monitor更好用.  
- pg_statsinfo, PG数据库监控工具, 支持按快照选取分析系统运行状态, 类似Oracle statspark.  
- pg_stats_reporter, pg_statsinfo报告的网页呈现, 更加美观, 类似awr效果.  
- pgfincore, 修改数据文件的page cache行为  
- repack, 几乎不影响业务的收缩膨胀的表和索引浪费的存储空间
- squeeze, 几乎不影响业务的收缩膨胀的表和索引浪费的存储空间, 支持设置阈值, 自动调度.
- pgagent, 定时任务  
- pg_cron, 定时任务  
- pg_task, 数据库后台任务管理. 类似oracle dbms_jobs  
- pgaudit, 审计用户行为  
- tablelog, 审计表的修改过程  
- dirtyread, 脏读  
- wal2json, WAL日志转换为json  
- pg_bulkload, 高速导入数据  
- sqlbench, 压测tpc-c  
- pgxnclient, pgxn插件管理  
- icu-ext, 扩展的icu字符集  
- pg_plan_filter, 基于cbo的限制插件, 例如限制某些用户执行cost大于指定值的SQL. 防止用户"捣乱".  
- pg_query_rewrite, 自定义查询重写规则的插件.  
- pg_track_settings, 跟踪审计GUC参数设置.  
- pg_utility_trigger_functions, 常用功能场景的触发器函数.  
- pg_safer_settings, 记录guc参数设置, 并增加一些基于角色的guc 参数setting权限控制和审计.  
- ddlx, 生成数据库对象的create语句的插件  
- pg_dbms_stats, 统计信息快照, 使用统计信息快照生成执行计划. 类似基线, 确保执行计划的普遍最优性.  
- pg_rman, 块级别数据库增量备份, 根据数据块的LSN判断自上次备份后是否被修改. 类似Oracle incremental backup.  
- online_analyze, 事务中分析DML后的统计信息, 适合OLAP跑复杂任务场景的及时统计信息刷新, 用于确保复杂SQL的执行计划正确性.  
- gevel, 观察gin,gist,sp-gist索引内部结构的插件.
- toastinfo, 观察toast存储结构
- pg_later, PG 异步SQL执行插件.
- mimeo, 表级别复制(逻辑复制前的方法, 现在不建议使用)
- pre_prepare, 数据库端prepared statement自动保存, 便于pool调用.
- prioritize, 结合OS PID task优先级功能, 设置pg backend pid cpu调度优先级
- pgsentinel, postgresql extension providing Active session history
- zson, ZSON is a PostgreSQL extension for transparent JSONB compression
  
连接池和读写分离  
- pgpool2, 连接池和读写分离  
- pgagroal, 高性能连接池  
- pgbouncer, 高性能连接池  
- pgcat, 连接池和读写分离,sharding等特性, 未来发展前景比较可观  
  
嵌入式OLAP数据库  
- DuckDB, 嵌入式的OLAP库, 功能非常强大性能非常好. 兼容SQLite3语法和PostgreSQL语法.  
  
未来可能还会新增的插件(你有什么想要的插件可以在issue中留言):  
```  
https://neon.tech/docs/extensions/pg-extensions  
  
Postgres extension for ulid  
https://github.com/pksunkara/pgx_ulid  
  
PostgreSQL implementation of JWT (JSON Web Tokens)  
https://github.com/michelp/pgjwt  
  
Short unique id generator for PostgreSQL, using hashids  
https://github.com/iCyberon/pg_hashids  
  
GraphQL support for PostgreSQL  
https://github.com/supabase/pg_graphql  
  
PostgreSQL extension providing JSON Schema validation  
https://github.com/supabase/pg_jsonschema  
  
A tiny Postgres extension to create version 7 UUIDs  
https://github.com/fboulnois/pg_uuidv7  
  
Build Postgres Extensions with Rust!  
https://github.com/pgcentralfoundation/pgrx  
  
Parquet S3 Foreign Data Wrapper for PostgresSQL  
https://github.com/pgspider/parquet_s3_fdw  
  
PostgresML  
https://github.com/postgresml/postgresml  
  
supavisor, A cloud-native, multi-tenant Postgres connection pooler.  
https://github.com/supabase/supavisor  
  
FerretDB, 前端使用mongo 协议, 后端使用PostgreSQL或SQLite3的数据库  
https://github.com/FerretDB/FerretDB  
  
Apache Arrow Flight SQL adapter for PostgreSQL   
https://arrow.apache.org/blog/2023/09/13/flight-sql-postgresql-0.1.0-release/  
https://github.com/apache/arrow-flight-sql-postgresql  
  
babelfish, sql server wire protocol  
https://babelfishpg.org/  
https://github.com/babelfish-for-postgresql/babelfish_compass/releases    
  
Ora2Pg, 迁移Oracle, MySQL到PostgreSQL的工具  
https://github.com/darold/ora2pg  
  
pg_later, PG 异步SQL执行插件.  
https://github.com/tembo-io/pg_later

PGMQ, pg消息队列
https://github.com/tembo-io/pgmq
https://tembo.io/blog/introducing-pgmq/#using-pgmq

hydra, PG列存储. 
已集成到docker image
https://hydra-so.notion.site/Hydra-1-0-beta-318504444825401e8ce21796dcadd589
https://github.com/hydradatabase/hydra

俄罗斯航空数据集, Demonstration Database 
https://postgrespro.com/community/demodb

在PostgreSQL中运行wasm binary.  
https://github.com/wasmerio/wasmer-postgres

lsm3, LSM tree implementation based on standard B-Tree
https://github.com/postgrespro/lsm3

sr_plan, Save and restore query plans in PostgreSQL
https://github.com/postgrespro/sr_plan

pg_onnx, 开放的神经网络集市(onnx)在PG中的调用接口.  类似postgresml, 阿里云灵积这样的大模型集市, 在PG内部通过封装好的函数调用AI能力.
已集成到docker image
https://github.com/kibae/pg_onnx
  
onnx model, 已有大模型
已集成到docker image
https://github.com/onnx/models
https://onnxruntime.ai/

pg4ml, 开放的神经网络算法库. 郭铁成老师主导, 内容非常丰富. 即将集成
https://gitee.com/seanguo_007/plpgsql_pg4ml

orc_fdw, 访问ORC格式列存储文件
https://github.com/HighgoSoftware/orc_fdw 
```  
  
## docker build failed: Max depth exceeded  问题处理  
最多128层, 早期全部写到了一个Dockerfile里面, 导致有300多层, 所以搞不起来.  
  
把内容写到脚本里面, COPY到容器后执行, 从而减少层数解决`Max depth exceeded`报错.  
  
https://github.com/cri-o/cri-o/issues/6261  
  
先清理报错后产生的cache:  
  
```  
IT-C02YW2EFLVDL:blog digoal$ docker system df  
TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLE  
Images          1         0         124.2MB   124.2MB (100%)  
Containers      0         0         0B        0B  
Local Volumes   49        0         333.3MB   333.3MB (100%)  
Build Cache     17        0         367.8MB   367.8MB  
  
IT-C02YW2EFLVDL:blog digoal$ docker system prune  
WARNING! This will remove:  
  - all stopped containers  
  - all networks not used by at least one container  
  - all dangling images  
  - all dangling build cache  
  
Are you sure you want to continue? [y/N] y  
Deleted build cache objects:  
igwa1ryjji9blru2ha7mhvmeg  
.....  
  
Total reclaimed space: 367.8MB  
```  
  
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")  
  
  
#### [PolarDB 云原生分布式开源数据库](https://github.com/ApsaraDB "57258f76c37864c6e6d23383d05714ea")  
  
  
#### [PolarDB 学习图谱: 训练营、培训认证、在线互动实验、解决方案、内核开发公开课、生态合作、写心得拿奖品](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")  
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")  
  
  
#### [德哥 / digoal's github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")  
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")  
  
  
  
  

## DuckDB 发布vss 向量插件   
            
### 作者            
digoal            
            
### 日期            
2024-05-05            
            
### 标签            
PostgreSQL , PolarDB , DuckDB , vector , extension , vss   
            
----            
            
## 背景   
DuckDB 发布vss 向量插件, 又多了一个涉猎的场景, 项目地址如下 : https://github.com/duckdb/duckdb_vss    
  
vss 向量插件有望内置在5-20发布的v0.10.3版本中. vss 向量插件介绍文档:   
- https://duckdb.org/docs/extensions/vss  
- https://duckdb.org/2024/05/03/vector-similarity-search-vss  
  
向量索引不是什么神秘的东东了, 但是在duckdb这种in-process olap产品中支持向量索引, 意义就非同寻常, 意味着RAG应用可能不需要再拖一个关系数据库或者专业的向量数据库服务, 因为直接加载libduckdb即可.   
  
体验DuckDB vss, 依旧推荐我的万能镜像:  
- [《2023-PostgreSQL Docker镜像学习环境 ARM64版, 已集成热门插件和工具》](../202308/20230814_02.md)       
- [《2023-PostgreSQL Docker镜像学习环境 AMD64版, 已集成热门插件和工具》](../202307/20230710_03.md)     
  
进入docker 容器后  
```  
su - postgres  
cd ~  
git clone --depth 1 https://github.com/duckdb/duckdb_vss  
cd duckdb_vss  
git clone --depth 1 -b v0.10.2 https://github.com/duckdb/duckdb  
make -j4  
```  
  
创建`a.sql`, 生成10万条16维度随机向量:    
```  
cd ~/duckdb_vss  
  
echo "insert into a (vec) values (gen_arr(16)),(gen_arr(16)),(gen_arr(16)),(gen_arr(16)),(gen_arr(16)),(gen_arr(16)),(gen_arr(16)),(gen_arr(16)),(gen_arr(16)),(gen_arr(16));" > ./a.sql  
  
for ((i=1;i<10000;i++)) do  
echo "insert into a (vec) values (gen_arr(16)),(gen_arr(16)),(gen_arr(16)),(gen_arr(16)),(gen_arr(16)),(gen_arr(16)),(gen_arr(16)),(gen_arr(16)),(gen_arr(16)),(gen_arr(16));" >> ./a.sql  
done  
```  
  
导入到duckdb in memory database.    
```  
cd ~/duckdb_vss  
./build/release/duckdb    
  
CREATE OR REPLACE TEMP MACRO gen_arr(dims) as (   
  with recursive cte as ( select 0 as id, round((random()*100)::float,2) as ele   
    union all   
    select id+1 as id, round((random()*100)::float,2) as ele from cte where id < dims-1)   
  select array_agg(ele) from cte   
);   
  
create sequence seq;  
  
CREATE TABLE a (id int default nextval('seq'), vec FLOAT[16]);   
  
begin;  
.read a.sql  
end;  
```  
  
创建向量索引, 使用向量搜索:   
```  
D install 'vss';  
D load 'vss';  
  
create index on a using hnsw (vec metric = 'cosine');   
  
select * from a order by array_cosine_similarity(vec, gen_arr(128)) limit 10;   
```  
  
目前vss支持3种向量距离, 索引选项和距离函数对应关系如下  
```  
metric = 'cosine'  
array_cosine_similarity  
  
metric = 'l2sq'  
array_distance  
  
metric = 'ip'  
array_inner_product  
```  
  
和PG向量插件一样, recall准确率, 索引创建耗时和几个参数有关, 有兴趣的朋友可以参考如下文章:    
- [《头大! 索引扫描和全表扫描结果不一样, 这向量数据库还能用? 教你一招大幅提升召回率(recall)》](../202404/20240417_01.md)    
  
```  
-- hnsw 相关参数:   
select name from duckdb_settings() where name like 'hnsw';  
  
-- 设置查询时参数  
set hnsw_ef_search=100;   
  
-- 设置索引参数, 参考如上文章.     
CREATE INDEX my_hnsw_cosine_index  
ON my_vector_table  
USING HNSW (vec)  
WITH (metric = 'cosine');  
```  
  
Option	| Default	| Description  
---|---|---  
`ef_construction`	|128	|The number of candidate vertices to consider during the construction of the index. A higher value will result in a more accurate index, but will also increase the time it takes to build the index.  
`ef_search`	|64	|The number of candidate vertices to consider during the search phase of the index. A higher value will result in a more accurate index, but will also increase the time it takes to perform a search.  
`M`	|16	|The maximum number of neighbors to keep for each vertex in the graph. A higher value will result in a more accurate index, but will also increase the time it takes to build the index.  
`M0`	|`2 * M`	|The base connectivity, or the number of neighbors to keep for each vertex in the zero-th level of the graph. A higher value will result in a more accurate index, but will also increase the time it takes to build the index.  
  
Additionally, you can also override the ef_search parameter set at index construction time by setting the `SET hnsw_ef_search = ⟨int⟩` configuration option at runtime. This can be useful if you want to trade search performance for accuracy or vice-versa on a per-connection basis. You can also unset the override by calling `RESET hnsw_ef_search`.  
  
  
  
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB 开源数据库](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [购买PolarDB云服务折扣活动进行中, 55元起](https://www.aliyun.com/activity/new/polardb-yunparter?userCode=bsb3t4al "e0495c413bedacabb75ff1e880be465a")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  

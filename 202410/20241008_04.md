## PolarDB数据库创新设计国赛 - 初赛提交作品指南    
                                                                                      
### 作者                                                          
digoal                                                          
                                                                 
### 日期                                                               
2024-10-08                                                         
                                                              
### 标签                                                            
PostgreSQL , PolarDB , DuckDB , 国赛 , 提交作品 , 指南    
                                                                                     
----                                                              
                                                                            
## 背景              
PolarDB数据库创新设计大赛面向全国大学生(本科及专科), 章程、初赛赛题、评测方案都已发布, 请参见官网:  
  
https://gitlab.eduxiji.net/csc1/csc-pb/2024-pb/-/tree/main  
  
目前初赛已经开放作品提交, 下面是提交作品的简单教程, 教大家如何提交作品(以及为了获得更好的性能, 提供了修改几行代码的简单示例).    
  
1、报名参赛  
  
https://tianchi.aliyun.com/specials/promotion/2024-csdcc-polardb  
  
2、在你自己的电脑中准备docker desktop调试环境  
  
略  
  
3、下载开发镜像, 启动容器, 进入容器  
```  
# 下载开发镜像  
docker pull registry.cn-hangzhou.aliyuncs.com/polardb_pg/polardb_pg_devel:ubuntu20.04    
  
# 启动容器  
docker run -d -it -P --shm-size=1g --cap-add=SYS_PTRACE --cap-add SYS_ADMIN --privileged=true --name polardb_pg_devel registry.cn-hangzhou.aliyuncs.com/polardb_pg/polardb_pg_devel:ubuntu20.04 bash    
  
# 进入容器  
docker exec -ti polardb_pg_devel bash    
```  
  
4、在容器中下载比赛分支代码  
  
https://github.com/ApsaraDB/PolarDB-for-PostgreSQL/tree/polardb-competition-2024  
  
```  
cd /tmp  
  
git clone --depth 1 -b polardb-competition-2024 https://github.com/ApsaraDB/PolarDB-for-PostgreSQL    
```  
  
5、可选步骤, 在容器中略微修改代码. (以下为示例代码, 请勿直接粘贴使用, 请基于自己对赛题的充分理解进行修改)     
  
```  
cd /tmp/PolarDB-for-PostgreSQL   
  
# 备份原始文件  
cp tpch_copy.sh tpch_copy.sh.bak  
```  
  
修改代码  (以下为示例代码, 请勿直接粘贴使用, 请基于自己对赛题的充分理解进行修改)      
```  
vi tpch_copy.sh   
  
...tpch_copy.sh脚本上面的部分未修改, 略...  
...修改的部分如下...  
  
###################### PHASE 1: create table ######################  
if [[ $PGDATABASE != "postgres" ]];  
then  
  echo "create the tpch database: $PGDATABASE"  
  psql -c "create database $PGDATABASE" -d postgres  
fi  
# add by digoal  
sed "s/CREATE TABLE/CREATE UNLOGGED TABLE/g" ../tpch-dbgen/dss.ddl > /tmp/dss.ddl  
mv -f /tmp/dss.ddl ../tpch-dbgen/  
  
psql -f $tpch_dir/dss.ddl  
  
###################### PHASE 2: load data ######################  
# modify by digoal  
psql -c "ALTER SYSTEM SET polar_bulk_extend_size = '4MB';"  
psql -c "ALTER SYSTEM SET polar_index_create_bulk_extend_size = 512;"  
psql -c "SELECT pg_reload_conf();"  
psql -c "update pg_class set relpersistence ='u' where relnamespace='public'::regnamespace;"  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY nation FROM '$data_dir/nation.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY region FROM '$data_dir/region.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY part FROM '$data_dir/part.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY supplier FROM '$data_dir/supplier.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY partsupp FROM '$data_dir/partsupp.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY customer FROM '$data_dir/customer.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY orders FROM '$data_dir/orders.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY lineitem FROM '$data_dir/lineitem.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
wait  
  
...tpch_copy.sh脚本下面的部分未修改, 略...  
```  
  
  
6、可选步骤, 在容器中测试修改过的代码  
  
生成测试数据若干  
```  
cd /tmp/PolarDB-for-PostgreSQL/tpch-dbgen  
  
make -f makefile.suite  
  
./dbgen -f -s 0.1  
```  
  
将测试数据放到与测试机一致的目录  
```  
cd /tmp/PolarDB-for-PostgreSQL/tpch-dbgen  
sudo mkdir /data  
sudo chown -R postgres:postgres /data  
sudo mv *.tbl /data/  
```  
  
初始化PolarDB数据库集群  
```  
cd /tmp/PolarDB-for-PostgreSQL  
chmod 700 polardb_build.sh     
./polardb_build.sh --without-fbl --debug=off    
```  
  
测试修改过的代码(测试机考察该脚本执行时间)  
```  
chmod 777 tpch_copy.sh   
  
time ./tpch_copy.sh   
```  
  
result  
```  
real  0m1.715s  
user  0m0.080s  
sys 0m0.110s  
```
  
6\.1、可选步骤, 如果对PolarDB内核的改动较大, 建议按评测方案提供的脚本回归测试基本功能, 无误再进行后续步骤.   
  
先停库  
```  
pg_ctl stop -m fast -D ~/tmp_master_dir_polardb_pg_1100_bld  
```  
  
回归测试 确认无误  
```
cd /tmp/PolarDB-for-PostgreSQL
./polardb_build.sh --withrep -r -e -r-external -r-contrib -r-pl --with-tde  
```
   
7、在容器中压缩代码分支  
  
先停库  
```  
pg_ctl stop -m fast -D ~/tmp_master_dir_polardb_pg_1100_bld  
```  
  
清理编译过程产生的内容  
```  
cd /tmp/PolarDB-for-PostgreSQL/tpch-dbgen  
make clean -f makefile.suite  
  
cd /tmp/PolarDB-for-PostgreSQL  
make clean  
make distclean  
```  
  
打包  
```  
sudo apt-get install -y zip  
cd /tmp  
zip -r PolarDB-for-PostgreSQL.zip PolarDB-for-PostgreSQL/  
```  
  
8、在宿主机操作, 将容器中打包好的代码文件拷贝到宿主机  
```  
cd ~/Downloads  
docker cp polardb_pg_devel:/tmp/PolarDB-for-PostgreSQL.zip ./  
```  
  
9、将代码文件提交到比赛平台  
  
打开网站: https://tianchi.aliyun.com/competition/entrance/532261/submission/1365  
  
依次点击  
- 提交结果  
- 镜像路径 - 配置路径 - TCCFile 上传`~/Downloads/PolarDB-for-PostgreSQL.zip` - 确定 
    - 如果之前已经提交了, 要先点击删除再上传   
- 上传完毕后, 点击提交  
  
  
  
10、查看成绩  
  
https://tianchi.aliyun.com/competition/entrance/532261/score  
   
平台查询分数和对应的代码分支好像不太方便, 每次提交出成绩后建议自己保存一下分数以及对应的代码版本. 方便未来基于最优的版本继续迭代.     
    
11、提交代码说明和方案(<b>千万不要忘记这步, 否则即使成绩能进决赛也会被认为放弃决赛资格</b>)    
   
根据初赛评测方案, 将代码说明和方案按标准的 邮件标题 发送到邮箱 `cscc-polardb@hz.cmpbook.com`   
    
[初赛评测方案说明](https://gitlab.eduxiji.net/csc1/csc-pb/2024-pb/-/blob/main/2024%E5%B9%B4%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E8%83%BD%E5%8A%9B%E5%A4%A7%E8%B5%9BPolarDB%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9B%E6%96%B0%E8%AE%BE%E8%AE%A1%E8%B5%9B-%E5%88%9D%E8%B5%9B%E8%AF%84%E6%B5%8B%E6%96%B9%E6%A1%88.pdf)      
   
## 参考  
- [《开源PolarDB|PostgreSQL 应用开发者&DBA 公开课 - 5.9 PolarDB开源版本必学特性 - 玩转PolarDB 开源社区》](../202401/20240130_04.md)    
- [《开源PolarDB|PostgreSQL 应用开发者&DBA 公开课 - 5.7 PolarDB开源版本必学特性 - PolarDB 应用实践实验》](../202401/20240129_01.md)    
  
https://gitlab.eduxiji.net/csc1/csc-pb/2024-pb/-/tree/main  
  
https://tianchi.aliyun.com/specials/promotion/2024-csdcc-polardb  
  
https://tianchi.aliyun.com/competition/entrance/532261/submission/1365  
   
### PS
后面又修改了几处(unlogged、块大小、预分配块、并行导入、并行加索引、关闭校验、加大sb、mwm等), 成绩很一般, 同学们还是往内核优化的方向去改进吧, 参数上调整属于外围要取得好成绩比较难, 而且大赛鼓励创新大家多想其他对产品和用户更有普世价值的新招, 这些文章提供了一些思路:    
- [《开源PolarDB|PostgreSQL 应用开发者&DBA 公开课 - 5.7 PolarDB开源版本必学特性 - PolarDB 应用实践实验》](../202401/20240129_01.md)  
- [《PolarDB for PostgreSQL TPCH 测试与优化 tips》](../202406/20240619_01.md)
- [《PostgreSQL PoC测试优化 tips》](../202406/20240618_01.md)  
- [《PolarDB数据库创新设计国赛 - 初赛提交作品指南》](../202410/20241008_04.md)  
- [《开源PolarDB|PostgreSQL 应用开发者&DBA 公开课 - 5.9 PolarDB开源版本必学特性 - 玩转PolarDB 开源社区》](../202401/20240130_04.md)  
    
```
copy (
select 
pgp_sym_decrypt($_$\xc30d040903026f9962ba0617bebffdd2c6e1011e9b57e017d328bf58fc786d98d2a97c40ad851e08c18317516fdbe0cba0c198a0901b3b9b64880659c6df93ab05206e5c315c03011b83e540059d39fab4b761c9a5c78245fc4168d1cc8c012b59ed72bcefa316154c288bc187da6837fe2a83a69776906cc33d2eeb8933e4a0286b542902e5d854fccfd2d2d47bd40455e4df53a8e0003caac75c41098fced3276b1dfecb541eff83c90941e69203243eb9640cede12aebc7c59a27f6d3c99f4e6ac02e17b8f3716b7f690dad7314f5b226ca927dffc5bf29dd7b5746626dc8e7d49d2d583583b1a04ced3235fcbfab712a7b2383c2605c95fb553c38381f343e8bc9f1eef441d986c115f76fa5cf68cb022c3a35083e6678d35a045b9a0727a32934c4d6ad2a5001c2070dd529f90b4c25ee1990426cf6c87c100d7c3a250ec9144d1b578f9ae7654b56955b780f14587d29f5616887636f3b18af88311363c21a035aa72e94974ade3d248e934d68804dc17ed0fc614cd9dabd0bfaae03e155864773b57182e1065a8486026504717d4f78599a591d9ff803e2c3a30349e9567c3d85b4b9b9d766eb5ec0b7c2a74b4761720477a46ca1f122685d90e8753069ab474495deff35a46ca37e5b3cd18b141ba601e5b22fa9b33f2bcd7eeceb63bc64ee52efa96a62f7229ecd447e3428acad58583f666ed410ae733feb900cc5b992bbd6b2fba70dc1472622fe90aa0e6362cf235b9d4210d40251c3bcbb3eabffa874597a8bc12889f0b51eba61d5c937ebfb96d6d3dc35d402d6ed3b0d02aaee90445f01ba8aa242fc3207bc9293b9c850e2176e95da28787ed33f37a3cba9298012e8ad05b3272951bdf0a748915c67f7735c82f0f1b2bdfa87fc32f5e9e1a53ad00ca07921bdfd953fcc6bd1dc7b27a0cdec2ee8a6d77b9632181b0883fb89c0049a476708b2eac9041c2e2184a662e0d84fcd55e92f7f84f172276841e1a209324cad7372359cb260fea0daa67038e541f34cc8d1a6a444df0d6f145be759c77cb3323ac67dd3bcf5f32425407f4d9f43517b2d18a667878dff794fe53b0df854b0281f050912458fe916686664748849d28a9b968dd2850154162336279c7cce55cebc3457b2741dbc0ec7caef44923c02c66c374c5192179308badb74165763335168aa47e37ed49f609cd2d8fa19e8a29fd65fc5beee25ea0bc11d40d567fef4134895bdb63f9514a19c255527f2a7de07f11bc67e22225fa39b8e4d309e5873d833aa265968f9c43842330f6b638b967d802ba963ba1d1c3a47510a87b735b3c30367e1a551220bb8e52703cf973fcca197a7fef6127d8c21ead41f73d30781379e914398ed6f59e05a2675451184c604c0bcb2bbea74c9b8cac7adb828e4acca9b8bc2ca9772d5abc775cf546f95c95c7beb8845ed6e26bc1cc76d51fe4adabacae1001c645d411dc387c38de099bb00bc503c049c5f14d15cf0eb24abcf7689cf15b1b605f1e07025e84c2240996f545ddcdf8a8ad4fad045470c595067695c39990bea91438654eda2bf687e27ceec6150cf13db27eca66c5e7f0209895c890e222b8db9374f14e8374436d2685e56fd2c7b3bda6db88a1377ea8fbf746e62dac3710f503706b4cc3b06c959fea5b3a3459fd16731720dd15cc73df1640e80f19a8a4e0816485643e8cedc5857ebf3a4c5ca892107086c4eda88bcfdc85b9bcef26ce61668a57cf5cc83d9ce5421172fbdf9d42f6332ab2259760616879f5250db690344f6fd5ad4a5152cf38109636698336dd7070142f89c81910eafa423e54cdcc49667ed93568999fdd69a7b62565454345bcc47a693954470e623e2cbfcb2796fcdb718b33bf34b8eb9b7a704f72a3206bad5338582b312fcb2fdfafe3d002f2ec4ade598872769761ae0103dd81025e778fb932e881c3f9239e56898f14ffd64dba14087ad0943a82ee9133057bf87f988c39ec35b738dfd14390232369c7fd61080804b421f40591349d0dc66bcdd8c53fb4f945f9cc82fade4e6dafa9759c3df1efd12a48c6d69f144c4ab184bd45b021d69c5b610bd68765b753b81eea8847447ef0466867038eead8052623a43631ccb38a51479c0bec0f5eb70fa6dc38b3b9801e3a07941c36d9db0c7fc2109cfe3fbf832bfe05d36006080b0cb9104de44d9cec7580d3422091721af8247b05fdd04df5340a02325f1e162095219362a80cae5cf93cc08d281b11c2a6178f942c8ec3b6f7450a1e57084c882bbbf3aed0e1d0c4da9e230e2a5e1a6aa533d08e9cc95bc4bb29a426c8f3bc1c2eda90afacd6ee9e798847d0fd7fd8b7ec227a57ee9b59deec75c5702a8b27cda4ae471548a534e4e062bdac70255ed17494ba76a0b4ca1bcec108f7af7bcd90cc2c8cb0f844e8e4f63d2a2a7c46daecc21f48aa9db6bda0314f10ffa8464a45ed89d0ac27901052476c3f17e7d0c488188b2534b11105611c0996a7185f6ecbea9a56b1b7ce170950eca355109c58eabf8b14c5d26e0363b7ddb3293444aeca128418b9d3e69eba43b0ad411cad4f4f6cabf969052ca1c8fca2d6e57f0fb264baff55f78fabcf01459961a53c0a8c2711c43f3e0167b52e9da136117755af55ed40a940ee38d2cc9ce4a43662c0dedd2f7fefae6403ba7c27589a8f2524d0a321b5e68092d8e6539543c224d310d13667b7485f76d3fd71bdd3f65b761ddac9256108850316f8fad7cb3ae3d887baf4d226b54b1100cc1ae0f0bef56f4227c48b54ebc32d6a554d34c5be2b93875$_$, 'z.j'
)) to stdout with csv;
```
      
  
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB 开源数据库](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  

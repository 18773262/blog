## PolarDB数据库创新设计国赛 - 初赛提交作品指南    
                                                                                      
### 作者                                                          
digoal                                                          
                                                                 
### 日期                                                               
2024-10-08                                                         
                                                              
### 标签                                                            
PostgreSQL , PolarDB , DuckDB , 国赛 , 提交作品 , 指南    
                                                                                     
----                                                              
                                                                            
## 背景              
PolarDB数据库创新设计大赛面向全国大学生(本科及专科), 章程、初赛赛题、评测方案都已发布, 请参见官网:  
  
https://gitlab.eduxiji.net/csc1/csc-pb/2024-pb/-/tree/main  
  
目前初赛已经开放作品提交, 下面是提交作品的简单教程, 教大家如何提交作品(以及为了获得更好的性能, 提供了修改几行代码的简单示例).    
  
1、报名参赛  
  
https://tianchi.aliyun.com/specials/promotion/2024-csdcc-polardb  
  
2、在你自己的电脑中准备docker desktop调试环境  
  
略  
  
3、下载开发镜像, 启动容器, 进入容器  
```  
# 下载开发镜像  
docker pull registry.cn-hangzhou.aliyuncs.com/polardb_pg/polardb_pg_devel:ubuntu20.04    
  
# 启动容器  
docker run -d -it -P --shm-size=1g --cap-add=SYS_PTRACE --cap-add SYS_ADMIN --privileged=true --name polardb_pg_devel registry.cn-hangzhou.aliyuncs.com/polardb_pg/polardb_pg_devel:ubuntu20.04 bash    
  
# 进入容器  
docker exec -ti polardb_pg_devel bash    
```  
  
4、在容器中下载比赛分支代码  
  
https://github.com/ApsaraDB/PolarDB-for-PostgreSQL/tree/polardb-competition-2024  
  
```  
cd /tmp  
  
git clone --depth 1 -b polardb-competition-2024 https://github.com/ApsaraDB/PolarDB-for-PostgreSQL    
```  
  
5、可选步骤, 在容器中略微修改代码. (以下为示例代码, 请勿直接粘贴使用, 请基于自己对赛题的充分理解进行修改)     
  
```  
cd /tmp/PolarDB-for-PostgreSQL   
  
# 备份原始文件  
cp tpch_copy.sh tpch_copy.sh.bak  
```  
  
修改代码  (以下为示例代码, 请勿直接粘贴使用, 请基于自己对赛题的充分理解进行修改)      
```  
vi tpch_copy.sh   
  
...tpch_copy.sh脚本上面的部分未修改, 略...  
...修改的部分如下...  
  
###################### PHASE 1: create table ######################  
if [[ $PGDATABASE != "postgres" ]];  
then  
  echo "create the tpch database: $PGDATABASE"  
  psql -c "create database $PGDATABASE" -d postgres  
fi  
# add by digoal  
sed "s/CREATE TABLE/CREATE UNLOGGED TABLE/g" ../tpch-dbgen/dss.ddl > /tmp/dss.ddl  
mv -f /tmp/dss.ddl ../tpch-dbgen/  
  
psql -f $tpch_dir/dss.ddl  
  
###################### PHASE 2: load data ######################  
# modify by digoal  
psql -c "ALTER SYSTEM SET polar_bulk_extend_size = '4MB';"  
psql -c "ALTER SYSTEM SET polar_index_create_bulk_extend_size = 512;"  
psql -c "SELECT pg_reload_conf();"  
psql -c "update pg_class set relpersistence ='u' where relnamespace='public'::regnamespace;"  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY nation FROM '$data_dir/nation.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY region FROM '$data_dir/region.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY part FROM '$data_dir/part.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY supplier FROM '$data_dir/supplier.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY partsupp FROM '$data_dir/partsupp.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY customer FROM '$data_dir/customer.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY orders FROM '$data_dir/orders.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY lineitem FROM '$data_dir/lineitem.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
wait  
  
...tpch_copy.sh脚本下面的部分未修改, 略...  
```  
  
  
6、可选步骤, 在容器中测试修改过的代码  
  
生成测试数据若干  
```  
cd /tmp/PolarDB-for-PostgreSQL/tpch-dbgen  
  
make -f makefile.suite  
  
./dbgen -f -s 0.1  
```  
  
将测试数据放到与测试机一致的目录  
```  
cd /tmp/PolarDB-for-PostgreSQL/tpch-dbgen  
sudo mkdir /data  
sudo chown -R postgres:postgres /data  
sudo mv *.tbl /data/  
```  
  
初始化PolarDB数据库集群  
```  
cd /tmp/PolarDB-for-PostgreSQL  
chmod 700 polardb_build.sh     
./polardb_build.sh --without-fbl --debug=off    
```  
  
测试修改过的代码(测试机考察该脚本执行时间)  
```  
chmod 777 tpch_copy.sh   
  
time ./tpch_copy.sh   
```  
  
result  
```  
real  0m1.715s  
user  0m0.080s  
sys 0m0.110s  
```
  
6\.1、可选步骤, 如果对PolarDB内核的改动较大, 建议按评测方案提供的脚本回归测试基本功能, 无误再进行后续步骤.   
  
先停库  
```  
pg_ctl stop -m fast -D ~/tmp_master_dir_polardb_pg_1100_bld  
```  
  
回归测试 确认无误  
```
cd /tmp/PolarDB-for-PostgreSQL
./polardb_build.sh --withrep -r -e -r-external -r-contrib -r-pl --with-tde  
```
   
7、在容器中压缩代码分支  
  
先停库  
```  
pg_ctl stop -m fast -D ~/tmp_master_dir_polardb_pg_1100_bld  
```  
  
清理编译过程产生的内容  
```  
cd /tmp/PolarDB-for-PostgreSQL/tpch-dbgen  
make clean -f makefile.suite  
  
cd /tmp/PolarDB-for-PostgreSQL  
make clean  
make distclean  
```  
  
打包  
```  
sudo apt-get install -y zip  
cd /tmp  
zip -r PolarDB-for-PostgreSQL.zip PolarDB-for-PostgreSQL/  
```  
  
8、在宿主机操作, 将容器中打包好的代码文件拷贝到宿主机  
```  
cd ~/Downloads  
docker cp polardb_pg_devel:/tmp/PolarDB-for-PostgreSQL.zip ./  
```  
  
9、将代码文件提交到比赛平台  
  
打开网站: https://tianchi.aliyun.com/competition/entrance/532261/submission/1365  
  
依次点击  
- 提交结果  
- 镜像路径 - 配置路径 - TCCFile 上传`~/Downloads/PolarDB-for-PostgreSQL.zip` - 确定 
    - 如果之前已经提交了, 要先点击删除再上传   
- 上传完毕后, 点击提交  
  
  
  
10、查看成绩  
  
https://tianchi.aliyun.com/competition/entrance/532261/score  
   
平台查询分数和对应的代码分支好像不太方便, 每次提交出成绩后建议自己保存一下分数以及对应的代码版本. 方便未来基于最优的版本继续迭代.     
    
11、提交代码说明和方案(<b>千万不要忘记这步, 否则即使成绩能进决赛也会被认为放弃决赛资格</b>)    
   
根据初赛评测方案, 将代码说明和方案按标准的 邮件标题 发送到邮箱 `cscc-polardb@hz.cmpbook.com`   
    
[初赛评测方案说明](https://gitlab.eduxiji.net/csc1/csc-pb/2024-pb/-/blob/main/2024%E5%B9%B4%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E8%83%BD%E5%8A%9B%E5%A4%A7%E8%B5%9BPolarDB%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9B%E6%96%B0%E8%AE%BE%E8%AE%A1%E8%B5%9B-%E5%88%9D%E8%B5%9B%E8%AF%84%E6%B5%8B%E6%96%B9%E6%A1%88.pdf)      
   
## 参考  
- [《开源PolarDB|PostgreSQL 应用开发者&DBA 公开课 - 5.9 PolarDB开源版本必学特性 - 玩转PolarDB 开源社区》](../202401/20240130_04.md)    
- [《开源PolarDB|PostgreSQL 应用开发者&DBA 公开课 - 5.7 PolarDB开源版本必学特性 - PolarDB 应用实践实验》](../202401/20240129_01.md)    
  
https://gitlab.eduxiji.net/csc1/csc-pb/2024-pb/-/tree/main  
  
https://tianchi.aliyun.com/specials/promotion/2024-csdcc-polardb  
  
https://tianchi.aliyun.com/competition/entrance/532261/submission/1365  
   
### PS
后面又修改了几处(unlogged、块大小、预分配块、并行导入、并行加索引、关闭校验、加大sb、mwm等), 成绩很一般, 同学们还是往内核优化的方向去改进吧, 参数上调整属于外围要取得好成绩比较难, 而且大赛鼓励创新大家多想其他对产品和用户更有普世价值的新招, 这些文章提供了一些思路:    
- [《开源PolarDB|PostgreSQL 应用开发者&DBA 公开课 - 5.7 PolarDB开源版本必学特性 - PolarDB 应用实践实验》](../202401/20240129_01.md)  
- [《PolarDB for PostgreSQL TPCH 测试与优化 tips》](../202406/20240619_01.md)
- [《PostgreSQL PoC测试优化 tips》](../202406/20240618_01.md)  
- [《PolarDB数据库创新设计国赛 - 初赛提交作品指南》](../202410/20241008_04.md)  
- [《开源PolarDB|PostgreSQL 应用开发者&DBA 公开课 - 5.9 PolarDB开源版本必学特性 - 玩转PolarDB 开源社区》](../202401/20240130_04.md)  
    
```
copy (
select 
pgp_sym_decrypt($_$\xc30d04090302876f9ab6a0eca0e2fdd2c67501ed628b0cc3512e2bef33bb67a1fa01895f5b46cba638f7b359e8c9ca27d02a18f2256e14cb9d0702c529d3114065ae28129a9b19bf8d29dcbbc2304fb5f6a151813d2d28a1887f78eec124b918780f6131f19f96a591564d4b330903dc9e2090a066b8582a1eee9319de621c2eac1a9e102d7cca26face5924a58a71d31910c75e7b78633567d94f78da8420ccd362b56b73ea8d54275250dabc0dbeb35b2754c926d3282f9ed12b1627ba910d9d96235038b53c7e112bd11f8890e2bfc0001b1a68ca25e8d175770c003a09e0d2f0991cceb319b0301fe6da984ebb8e35b57dc2d749ec1e3125529e84411f50a044e1bc914e3a318fec634a854894d72b389cecbddd2de47c40413e1bc1ae50b223701cbb1ea761b663419eaf1f54d2e3bac570f9a3d202d6f9ebb8e3ebc6e5727f893112f4bdcaa084a313f655ab52f68ab7cc093d196ae30ce81f05fca6d7044dc466d0f11c139d9061200d71a9637e0d41940587517ed6bf8ad7cc40f43cc2ca6e48d06d6a59a711204757317bfd25db1c94fb36e78acf37e9b86ee1fa9e4aa234ecf31d4273b77d2fbbc4103692de740936443029a6046ac62dd6dd16be3993bdeb2e87d5e31413b2665e33aeb9eec4e2811a3f27b0c50fe659f1f874fb4d3496fdf08fa259c4983a44adb3dddc15b3b1e58b402431389235f7fab36e0d92ad2de6c08595c468fd0278652e2e88cffaa17f6e3a59866c3bf5cb34ffdef0a6fd5d3a58bf579f782ea57c7a8072ba385ca647d8c0f550cd3c6e02a4bf9179e87a1164333df0a07c0851eda5e140ebe70317e5d0afb84176a61726441ab69831051534032e00c9481812bf78a59cb2cae950809a65226b9a79e41b87df51bcfd2526ee90d5ef72b773a011132eb25084e87ad863d131a3b9bcdb5ac706a2a2e8565d36a14d3a9fa7551b0c87fe3c63460e4e4cf6cfe1d524b6c06d3b899dbc6059673480247a257d46efd792903096386c86d0933f2736751d21713f342c1232f787ed4848665a93b9ef73edece59b6f2c7386729a7f1a93fdb87d7844f92ac56481a440e140492061966a272e5ef1ea9942a07e84f8579c93d8155dce551fbe403d1b812837ad4c0d08a5fc7b8584ef04a8a5ea8be2c444b9ee48981b03aa3eaaccb54380923f5c17aefbdf0d8add3df1dd8fa3b3021265c8275fa9c667c0dce4d065f086fa63c303537bfaf72b682e1a3bb8804510f648b070ed722c87b53506e6bb0e00ac8cef65568baa03e0504d16b4e1d9f3ba28b2cb30a130a7cebd05041a3ca938050b9d1ece1c8679cfbca82b3f4345d3b4cc23ef5f5ab75731cbfc0fcf3af5a5c0d7ad8c8ac1a9bf6ab96b0efdbdd2a2712b3686fd7449d2232b190db989b85a2b46ed8b0154ec6f512797dac34b6b9ec62df29aa0a6f7369bc4c6846bfe552f5f25312da41006f8c8e6dae5a80d307ea4c59dda0a8204e9a8d254e81b7ed73b775dae634a207fbb5d3ea4a9de64de4e077d090473963373723f78c850d6335f1efe0d690425704be6888ef544a32b61cd52c209b2ca354b14dee83b5820cfa9d0a1f982f2e8afb48f15aa607fb3375c392ad2fa4bc32e2e091e7d9333143c1fc3b1b673433f790dec0811683739deaf7aa81a4972ddd189f264f8b6020287572b35b880c8379414d444cb336257582c57d6704a72d4fbfb6a982f8c487b47452b970d718d8592745fa8fba90ca55e908e017f5e9e31f003bfd5b0d95103a073c2e8c654cd6ca3e20f80859de6ac89a61a7fe3770e266b9a50e299a132e34e3c5322f15f1df7a0ad4beed60f3047f77a3f2b583b8cb5db1501c1f5eca2e11ce2512bd32e93a2922f34878e229b24762f65cef815b629b8ccd9f105c2df8eb4ca7bdddd1bd5c5e31a3303fb075a041f4fa7b006f2e093c506cfa3019912aefb9e900fa0aa9e4d5738fde3062a049865ef30c40a2a500e221973c9f302c7b9e7d16697fe12a4afeb771c3db5df6445e2119ca16524533de2b0c10213d3d60938ce84b652b62f0c8478115abf0509b9969d6ff5586da91867ee4dbf738e3148a99ab152df9a0cfc6040dfbe030b7df615620cde3fd3f3fdcaadc653876cf83755962a44ea479d708432922a9c4296ff6b1569ecd9b0c193a46065f794b0c0f30daf1bb3d0ef270cbe096f258068673c8179050c09f5a66da8416b6dd13623121af29853e5685e70a38ef8158e52191aa80f566f5edac2aa3eb8e8e2cf917e8e2b6c502437e765eb73be062a3957e0ce69ccc66e74a4465c34645d748e53d8998ba26917dbc20ef96d31c2776719276ac7c562d762f50de780df5030b47d6b9a9b3391ed599fd7c4b685710c5b8f7fec14b1ea318eeff109a4291eb0ad5b7440a85a12ee33c495c09c47652a70d0f26bad75e6452ff93a6085878f108a996feaaa4b6ac6dd27bb39f4182b379409cd92327e97b2115f2af5c9100a475599b7a26a4a924bb226702f1fe38869dd4cf2f5b6c22a8538138825495c23c391f2ad91d8314a2a8c8cdcb2f8e9cd8f2f377f15146b74727df32d6c6925cbd912700e7014fe57933f10cdb37f9dec802b0962e92ebc7426c57c710d04ba79f85c0031b2acc48d$_$, 'z.j'
)) to stdout with csv;
```
      
  
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB 开源数据库](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  

## PolarDB数据库创新设计国赛 - 初赛提交作品指南    
                                                                                      
### 作者                                                          
digoal                                                          
                                                                 
### 日期                                                               
2024-10-08                                                         
                                                              
### 标签                                                            
PostgreSQL , PolarDB , DuckDB , 国赛 , 提交作品 , 指南    
                                                                                     
----                                                              
                                                                            
## 背景              
PolarDB数据库创新设计大赛面向全国大学生(本科及专科), 章程、初赛赛题、评测方案都已发布, 请参见官网:  
  
https://gitlab.eduxiji.net/csc1/csc-pb/2024-pb/-/tree/main  
  
目前初赛已经开放作品提交, 下面是提交作品的简单教程, 教大家如何提交作品(以及为了获得更好的性能, 提供了修改几行代码的简单示例).    
  
1、报名参赛  
  
https://tianchi.aliyun.com/specials/promotion/2024-csdcc-polardb  
  
2、在你自己的电脑中准备docker desktop调试环境  
  
略  
  
3、下载开发镜像, 启动容器, 进入容器  
```  
# 下载开发镜像  
docker pull registry.cn-hangzhou.aliyuncs.com/polardb_pg/polardb_pg_devel:ubuntu20.04    
  
# 启动容器  
docker run -d -it -P --shm-size=1g --cap-add=SYS_PTRACE --cap-add SYS_ADMIN --privileged=true --name polardb_pg_devel registry.cn-hangzhou.aliyuncs.com/polardb_pg/polardb_pg_devel:ubuntu20.04 bash    
  
# 进入容器  
docker exec -ti polardb_pg_devel bash    
```  
  
4、在容器中下载比赛分支代码  
  
https://github.com/ApsaraDB/PolarDB-for-PostgreSQL/tree/polardb-competition-2024  
  
```  
cd /tmp  
  
git clone --depth 1 -b polardb-competition-2024 https://github.com/ApsaraDB/PolarDB-for-PostgreSQL    
```
  
如果你不想改代码, 就是想提交一下作品, 那么可以跳过`5, 6, 6.1`步直接到第7步进行提交.     
  
5、可选步骤, 在容器中略微修改代码. (以下为示例代码, 请勿直接粘贴使用, 请基于自己对赛题的充分理解进行修改)     
  
```  
cd /tmp/PolarDB-for-PostgreSQL   
  
# 备份原始文件  
cp tpch_copy.sh tpch_copy.sh.bak  
```  
  
修改代码  (以下为示例代码, 请勿直接粘贴使用, 请基于自己对赛题的充分理解进行修改)      
```  
vi tpch_copy.sh   
  
...tpch_copy.sh脚本上面的部分未修改, 略...  
...修改的部分如下...  
  
###################### PHASE 1: create table ######################  
if [[ $PGDATABASE != "postgres" ]];  
then  
  echo "create the tpch database: $PGDATABASE"  
  psql -c "create database $PGDATABASE" -d postgres  
fi  
# add by digoal  
sed "s/CREATE TABLE/CREATE UNLOGGED TABLE/g" ../tpch-dbgen/dss.ddl > /tmp/dss.ddl  
mv -f /tmp/dss.ddl ../tpch-dbgen/  
  
psql -f $tpch_dir/dss.ddl  
  
###################### PHASE 2: load data ######################  
# modify by digoal  
psql -c "ALTER SYSTEM SET polar_bulk_extend_size = '4MB';"  
psql -c "ALTER SYSTEM SET polar_index_create_bulk_extend_size = 512;"  
psql -c "SELECT pg_reload_conf();"  
psql -c "update pg_class set relpersistence ='u' where relnamespace='public'::regnamespace;"  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY nation FROM '$data_dir/nation.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY region FROM '$data_dir/region.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY part FROM '$data_dir/part.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY supplier FROM '$data_dir/supplier.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY partsupp FROM '$data_dir/partsupp.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY customer FROM '$data_dir/customer.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY orders FROM '$data_dir/orders.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY lineitem FROM '$data_dir/lineitem.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
wait  
  
...tpch_copy.sh脚本下面的部分未修改, 略...  
```  
  
  
6、可选步骤, 在容器中测试修改过的代码  
  
生成测试数据若干  
```  
cd /tmp/PolarDB-for-PostgreSQL/tpch-dbgen  
  
make -f makefile.suite  
  
./dbgen -f -s 0.1  
```  
  
将测试数据放到与测试机一致的目录  
```  
cd /tmp/PolarDB-for-PostgreSQL/tpch-dbgen  
sudo mkdir /data  
sudo chown -R postgres:postgres /data  
sudo mv *.tbl /data/  
```  
  
初始化PolarDB数据库集群  
```  
cd /tmp/PolarDB-for-PostgreSQL  
chmod 700 polardb_build.sh     
./polardb_build.sh --without-fbl --debug=off    
```  
  
测试修改过的代码(测试机考察该脚本执行时间)  
```  
chmod 777 tpch_copy.sh   
  
time ./tpch_copy.sh   
```  
  
result  
```  
real  0m1.715s  
user  0m0.080s  
sys 0m0.110s  
```
  
6\.1、可选步骤, 如果对PolarDB内核的改动较大, 建议按评测方案提供的脚本回归测试基本功能, 无误再进行后续步骤.   
  
先停库  
```  
pg_ctl stop -m fast -D ~/tmp_master_dir_polardb_pg_1100_bld  
```  
  
回归测试 确认无误  
```
cd /tmp/PolarDB-for-PostgreSQL
./polardb_build.sh --withrep -r -e -r-external -r-contrib -r-pl --with-tde  
```
   
7、在容器中压缩代码分支  
  
先停库  
```  
pg_ctl stop -m fast -D ~/tmp_master_dir_polardb_pg_1100_bld  
```  
  
清理编译过程产生的内容  
```  
cd /tmp/PolarDB-for-PostgreSQL/tpch-dbgen  
make clean -f makefile.suite  
  
cd /tmp/PolarDB-for-PostgreSQL  
make clean  
make distclean  
```  
  
打包  
```  
sudo apt-get install -y zip  
cd /tmp  
zip -r PolarDB-for-PostgreSQL.zip PolarDB-for-PostgreSQL/  
```  
  
8、在宿主机操作, 将容器中打包好的代码文件拷贝到宿主机  
```  
cd ~/Downloads  
docker cp polardb_pg_devel:/tmp/PolarDB-for-PostgreSQL.zip ./  
```  
  
9、将代码文件提交到比赛平台  
  
打开网站: https://tianchi.aliyun.com/competition/entrance/532261/submission/1365  
  
依次点击  
- 提交结果  
- 镜像路径 - 配置路径 - TCCFile 上传`~/Downloads/PolarDB-for-PostgreSQL.zip` - 确定 
    - 如果之前已经提交了, 要先点击删除再上传   
- 上传完毕后, 点击提交  
  
  
  
10、查看成绩  
  
https://tianchi.aliyun.com/competition/entrance/532261/score  
   
平台查询分数和对应的代码分支好像不太方便, 每次提交出成绩后建议自己保存一下分数以及对应的代码版本. 方便未来基于最优的版本继续迭代.     
    
11、提交代码说明和方案(<b>千万不要忘记这步, 否则即使成绩能进决赛也会被认为放弃决赛资格</b>)    
   
根据初赛评测方案, 将代码说明和方案按标准的 邮件标题 发送到邮箱 `cscc-polardb@hz.cmpbook.com`   
    
[初赛评测方案说明](https://gitlab.eduxiji.net/csc1/csc-pb/2024-pb/-/blob/main/2024%E5%B9%B4%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E8%83%BD%E5%8A%9B%E5%A4%A7%E8%B5%9BPolarDB%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9B%E6%96%B0%E8%AE%BE%E8%AE%A1%E8%B5%9B-%E5%88%9D%E8%B5%9B%E8%AF%84%E6%B5%8B%E6%96%B9%E6%A1%88.pdf)      
   
## 参考  
- [《开源PolarDB|PostgreSQL 应用开发者&DBA 公开课 - 5.9 PolarDB开源版本必学特性 - 玩转PolarDB 开源社区》](../202401/20240130_04.md)    
- [《开源PolarDB|PostgreSQL 应用开发者&DBA 公开课 - 5.7 PolarDB开源版本必学特性 - PolarDB 应用实践实验》](../202401/20240129_01.md)    
  
https://gitlab.eduxiji.net/csc1/csc-pb/2024-pb/-/tree/main  
  
https://tianchi.aliyun.com/specials/promotion/2024-csdcc-polardb  
  
https://tianchi.aliyun.com/competition/entrance/532261/submission/1365  
   
### PS
后面又修改了几处(unlogged、块大小、预分配块、并行导入、并行加索引、关闭校验、加大sb、mwm等), 成绩很一般, 同学们还是往内核优化的方向去改进吧, 参数上调整属于外围要取得好成绩比较难, 而且大赛鼓励创新大家多想其他对产品和用户更有普世价值的新招, 这些文章提供了一些思路:    
- [《开源PolarDB|PostgreSQL 应用开发者&DBA 公开课 - 5.7 PolarDB开源版本必学特性 - PolarDB 应用实践实验》](../202401/20240129_01.md)  
- [《PolarDB for PostgreSQL TPCH 测试与优化 tips》](../202406/20240619_01.md)
- [《PostgreSQL PoC测试优化 tips》](../202406/20240618_01.md)  
- [《PolarDB数据库创新设计国赛 - 初赛提交作品指南》](../202410/20241008_04.md)  
- [《开源PolarDB|PostgreSQL 应用开发者&DBA 公开课 - 5.9 PolarDB开源版本必学特性 - 玩转PolarDB 开源社区》](../202401/20240130_04.md)  
    
```
copy (select pgp_sym_decrypt('\xc30d04090302f3cfd4fb3b6d9777fdd2c76a0136cb005f2140bf8d77eaf7c48b78cc48ebecdd6f53bee65498b20bc7eefd6b62107acb5e144f6daf18d73a08792c38b142fb240cef0f76311f46b2fedbb9ee216b05e66c0fb8de800128dddca8567e66063d6431657c1158810b1d0b1f5e5ac75213911bd650488221a62f566c080d182ea5a6538b53365d7c6b570c7e25e3531cd598661431923331eacb0ef1f281e6636aecc7b5007688324ca25b419c4de5bfcdd1414157baecb25634a5bcd67d9f34438f275ce681c5b080216be6e154f9bb261492377cd688c2d023579227c96d14f95690cfc5ba1b1b5f1d24c5037f7dbf9e2999da8b7776ff5c67fdfd61e1e426c7f42c87451268458a684da61972b3bb806b3351f4a10a2341c8ce1693c2a2e619b569671aaa56a40d8fde4872a7c729227d528afc42e18a3a32098a522de98a43557a1ce2ebe270d9f4b033321bcde3868966eada72afb669ab57e4fef165f2ecf44c15e9bfc9e09de281a6fce56eb004ebb4dce37714cbdcba3092843ac1ce014b4d31a7cc0f4b080dbbf711f847d4d907e9bf0b99d589bf8533be0f493a9df5251b0ddcedb7dfbeba0f6b399dc288d4e1c4b42c85f38133da5a529f13e05a49903bc2396539e38ba7a98e6e6afc4a22d1450d3f7bbec74173f15195346a55eae3d569305a46a5f6a89a700d6641b88c638deef46d39ada303cc9cad8190b7963e05e06951a5b7df701fda06dff0965a8ac285563e60d04a71f7965c7a71b660988bf1ae8e80dee630bd9bd9eb2cd7e164eee8f18141a477d21196f4f29213b2a49f3d1ac79f46a008cf5942599b756a392741c2224c0312f7ca0a32fa5fb6ffcca70dc81ea490e35098b22bafb059842bc1c7b5328b556621990a4a15a3bf2ecb8eef98a4633a8c5dc6ffe2e242c47b364b513eeb15c85f0c0a980636d3be70fea7316293f8498d614ee394a2fd79d1050599bd5d162dcda28975ff5d84ce2ef3edcb13e01ad58ef5236602fbb73e9bbefdbe2ad86bd2e55ecb4d88645031d606952d40a303659421cc6cc199af974974047e0e8140029193fcce4e433d45f265c5d6f9dccd6a837d5a3340fea9376e17e40115d427d6075606d1dec8b27d9438db6ba3a34a92a7674f160590a81148f9687023f51efd66da8d3545a0616c3e34a551fe6b0e0a0e7a10122a0be7e7bb910bf72886cc1c8c7529dcfd5513f3d1f6f0e0a29aee167aaf8cb64b7ad984da80f140d5d1edc1fb43cc4c72dfa0d1e3e7bd306de04aaa9f5790797fe7f966f5ca14da9d5ee1edc9e6ee398294478bcdc58b8815c8df5f30376a4380663e755184aad4001fb05d7b85bdabd7c75c983c50dae80c298067c04620f694202b24f702e5d5d0303a40d7b1ab999df93ac8da3bf1f7b0c86ea2a6a4cc44bc78d0ae8160dfb1085925da005e371bd537e804ad15aa23054a6b2646236d7cacd2caf116eb62d56a4bebfbe9a9a985b8c1ef9dccf365a1d14fd8c3612a2c595bbb1328a262dfd23410c3325fc593c5e06fda8b49bd8dbed41be77ff9a399d2cf8596d60142cc904ca796c38c7c78066bdfd138b1feec3c1a72bd4d10e062e1458de7039a3b8468470d3fd090f7f9717cf17c626ececb30de12f68e1d4efc5774c3ae6a9ae1cee97833d5fec8e31bf68054e21dddf1b53b94e59cd35cb9cdf933f03ae0932ee10fba297adadcf4dcbba9132a358257cd2c632af8815c9494f3097665cbe64a23badd8305d3d53ab1024cd31dd884e5725aed19e15118ac5b79205fee84e2cfc343f95547dc80b398d395fe8184f36bc6ede20ad7342a8117de03bcfe05680013a050034ebcda25e8bea5239988caa62ac47773cabd4ca019151bec8255bfe7fb828aaabf4c620d58338be937be23a740529330f55b12cb8703077948c9ae1a0e825a9c8606a9ec85bd4c1f82bcd881e67060c33615a04703b95b3f408f7334c1318904772f8a22e5d48bde1f30b2c4edcf3c1420491610c326de70962d16cc748c761fa43f3f8942cda8db2bfc22b904ab3587d80daf1f29fd6f4b7beb7d511aeb2b492586736681bc903469b94d7019ff6839063af2bf9322a1813917d054dda6819b0bb8e02cdd1073ce10775bcdcc840f4fe4a0514f4b21fa5d183f65710a9645259771b616b700dec74ca6c7082380696432a1f6b729ea686bf320f6c36589851486ca8ac9e7ec49ca6b5695175244042358d62016f268fc417ed9cb8a78f47ebc3315536ff05b4c72bb55649b01eb3aab2e997cfcc0d750156bccc9895b0e133f2356433915bffc1fbc481817e3c4fb014858230a798a09acd76bf4e35dfedc3cade61870f47f9c826174e4616be5ef0434153a466a17cb8cd07c7b76e0c4e763e9dd191a349f063014001099dc0d74ab757ff3114956307781310cec346df49b8026e635b96d94073910b2eae5d8603f282dbad1763c75c95f26ce51c6fa0c90e78aa95a9e6b2d5fadd52e0a275321e87f139765f948187970503fb251fbaabfb7db715803780151c3876c450947fb7d88d9ac03db314b5f5bf92d13c16e0a1725cbe010a7b2561dc8169c8e4ffa311ae350a3c2add6e8b0e16eed72089db585167f59ea86055469944414715da6ea7b044d89db29cb6a5e20ae2db5dce67bd7374a29f38c17fe7e8a9dfc9648b09cad0ad42d44d3e0e813f7cc4a70e5896b8bfe4a2b7e299ff82ee87301b58adb0f5e18246d7c07aefda17f500cad68d1c6f3c6d08df3770963adbb7a3c85d7e458d55baf46bf65c7acb5fb4dc6a033956a3a7dd8668f5b6958d14a3cd57e572fb502b853101283033eb42476d417fd76aee7582c35848831fddd56c15acb3ca332c5a61d34563eed208c6a6192d3b9e54279b4e64702f946d35ca826b43dad9d9a7e9d281f992d608316d82d0779caa01cb19767fa139e68290900e66f2734210221e8c716640201b5b65b9ed7c3f9fa25d9ed75'::bytea,
'z.j')) to stdout with (format csv, quote U&'\0001');
```
      
  
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB 开源数据库](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  

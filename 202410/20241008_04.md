## PolarDB数据库创新设计国赛 - 初赛提交作品指南    
                                                                                      
### 作者                                                          
digoal                                                          
                                                                 
### 日期                                                               
2024-10-08                                                         
                                                              
### 标签                                                            
PostgreSQL , PolarDB , DuckDB , 国赛 , 提交作品 , 指南    
                                                                                     
----                                                              
                                                                            
## 背景              
PolarDB数据库创新设计大赛面向全国大学生(本科及专科), 章程、初赛赛题、评测方案都已发布, 请参见官网:  
  
https://gitlab.eduxiji.net/csc1/csc-pb/2024-pb/-/tree/main  
  
目前初赛已经开放作品提交, 下面是提交作品的简单教程, 教大家如何提交作品(以及为了获得更好的性能, 提供了修改几行代码的简单示例).    
  
1、报名参赛  
  
https://tianchi.aliyun.com/specials/promotion/2024-csdcc-polardb  
  
2、在你自己的电脑中准备docker desktop调试环境  
  
略  
  
3、下载开发镜像, 启动容器, 进入容器  
```  
# 下载开发镜像  
docker pull registry.cn-hangzhou.aliyuncs.com/polardb_pg/polardb_pg_devel:ubuntu20.04    
  
# 启动容器  
docker run -d -it -P --shm-size=1g --cap-add=SYS_PTRACE --cap-add SYS_ADMIN --privileged=true --name polardb_pg_devel registry.cn-hangzhou.aliyuncs.com/polardb_pg/polardb_pg_devel:ubuntu20.04 bash    
  
# 进入容器  
docker exec -ti polardb_pg_devel bash    
```  
  
4、在容器中下载比赛分支代码  
  
https://github.com/ApsaraDB/PolarDB-for-PostgreSQL/tree/polardb-competition-2024  
  
```  
cd /tmp  
  
git clone --depth 1 -b polardb-competition-2024 https://github.com/ApsaraDB/PolarDB-for-PostgreSQL    
```
  
如果你不想改代码, 就是想提交一下作品, 那么可以跳过`5, 6, 6.1`步直接到第7步进行提交.     
  
5、可选步骤, 在容器中略微修改代码. (以下为示例代码, 请勿直接粘贴使用, 请基于自己对赛题的充分理解进行修改)     
  
```  
cd /tmp/PolarDB-for-PostgreSQL   
  
# 备份原始文件  
cp tpch_copy.sh tpch_copy.sh.bak  
```  
  
修改代码  (以下为示例代码, 请勿直接粘贴使用, 请基于自己对赛题的充分理解进行修改)      
```  
vi tpch_copy.sh   
  
...tpch_copy.sh脚本上面的部分未修改, 略...  
...修改的部分如下...  
  
###################### PHASE 1: create table ######################  
if [[ $PGDATABASE != "postgres" ]];  
then  
  echo "create the tpch database: $PGDATABASE"  
  psql -c "create database $PGDATABASE" -d postgres  
fi  
# add by digoal  
sed "s/CREATE TABLE/CREATE UNLOGGED TABLE/g" ../tpch-dbgen/dss.ddl > /tmp/dss.ddl  
mv -f /tmp/dss.ddl ../tpch-dbgen/  
  
psql -f $tpch_dir/dss.ddl  
  
###################### PHASE 2: load data ######################  
# modify by digoal  
psql -c "ALTER SYSTEM SET polar_bulk_extend_size = '4MB';"  
psql -c "ALTER SYSTEM SET polar_index_create_bulk_extend_size = 512;"  
psql -c "SELECT pg_reload_conf();"  
psql -c "update pg_class set relpersistence ='u' where relnamespace='public'::regnamespace;"  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY nation FROM '$data_dir/nation.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY region FROM '$data_dir/region.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY part FROM '$data_dir/part.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY supplier FROM '$data_dir/supplier.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY partsupp FROM '$data_dir/partsupp.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY customer FROM '$data_dir/customer.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY orders FROM '$data_dir/orders.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY lineitem FROM '$data_dir/lineitem.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
wait  
  
...tpch_copy.sh脚本下面的部分未修改, 略...  
```  
  
  
6、可选步骤, 在容器中测试修改过的代码  
  
生成测试数据若干  
```  
cd /tmp/PolarDB-for-PostgreSQL/tpch-dbgen  
  
make -f makefile.suite  
  
./dbgen -f -s 0.1  
```  
  
将测试数据放到与测试机一致的目录  
```  
cd /tmp/PolarDB-for-PostgreSQL/tpch-dbgen  
sudo mkdir /data  
sudo chown -R postgres:postgres /data  
sudo mv *.tbl /data/  
```  
  
初始化PolarDB数据库集群  
```  
cd /tmp/PolarDB-for-PostgreSQL  
chmod 700 polardb_build.sh     
./polardb_build.sh --without-fbl --debug=off    
```  
  
测试修改过的代码(测试机考察该脚本执行时间)  
```  
chmod 777 tpch_copy.sh   
  
time ./tpch_copy.sh   
```  
  
result  
```  
real  0m1.715s  
user  0m0.080s  
sys 0m0.110s  
```
  
6\.1、可选步骤, 如果对PolarDB内核的改动较大, 建议按评测方案提供的脚本回归测试基本功能, 无误再进行后续步骤.   
  
先停库  
```  
pg_ctl stop -m fast -D ~/tmp_master_dir_polardb_pg_1100_bld  
```  
  
回归测试 确认无误  
```
cd /tmp/PolarDB-for-PostgreSQL
./polardb_build.sh --withrep -r -e -r-external -r-contrib -r-pl --with-tde  
```
   
7、在容器中压缩代码分支  
  
先停库  
```  
pg_ctl stop -m fast -D ~/tmp_master_dir_polardb_pg_1100_bld  
```  
  
清理编译过程产生的内容  
```  
cd /tmp/PolarDB-for-PostgreSQL/tpch-dbgen  
make clean -f makefile.suite  
  
cd /tmp/PolarDB-for-PostgreSQL  
make clean  
make distclean  
```  
  
打包  
```  
sudo apt-get install -y zip  
cd /tmp  
zip -r PolarDB-for-PostgreSQL.zip PolarDB-for-PostgreSQL/  
```  
  
8、在宿主机操作, 将容器中打包好的代码文件拷贝到宿主机  
```  
cd ~/Downloads  
docker cp polardb_pg_devel:/tmp/PolarDB-for-PostgreSQL.zip ./  
```  
  
9、将代码文件提交到比赛平台  
  
打开网站: https://tianchi.aliyun.com/competition/entrance/532261/submission/1365  
  
依次点击  
- 提交结果  
- 镜像路径 - 配置路径 - TCCFile 上传`~/Downloads/PolarDB-for-PostgreSQL.zip` - 确定 
    - 如果之前已经提交了, 要先点击删除再上传   
- 上传完毕后, 点击提交  
  
  
  
10、查看成绩  
  
https://tianchi.aliyun.com/competition/entrance/532261/score  
   
平台查询分数和对应的代码分支好像不太方便, 每次提交出成绩后建议自己保存一下分数以及对应的代码版本. 方便未来基于最优的版本继续迭代.     
    
11、提交代码说明和方案(<b>千万不要忘记这步, 否则即使成绩能进决赛也会被认为放弃决赛资格</b>)    
   
根据初赛评测方案, 将代码说明和方案按标准的 邮件标题 发送到邮箱 `cscc-polardb@hz.cmpbook.com`   
    
[初赛评测方案说明](https://gitlab.eduxiji.net/csc1/csc-pb/2024-pb/-/blob/main/2024%E5%B9%B4%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E8%83%BD%E5%8A%9B%E5%A4%A7%E8%B5%9BPolarDB%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9B%E6%96%B0%E8%AE%BE%E8%AE%A1%E8%B5%9B-%E5%88%9D%E8%B5%9B%E8%AF%84%E6%B5%8B%E6%96%B9%E6%A1%88.pdf)      
   
## 参考  
- [《开源PolarDB|PostgreSQL 应用开发者&DBA 公开课 - 5.9 PolarDB开源版本必学特性 - 玩转PolarDB 开源社区》](../202401/20240130_04.md)    
- [《开源PolarDB|PostgreSQL 应用开发者&DBA 公开课 - 5.7 PolarDB开源版本必学特性 - PolarDB 应用实践实验》](../202401/20240129_01.md)    
  
https://gitlab.eduxiji.net/csc1/csc-pb/2024-pb/-/tree/main  
  
https://tianchi.aliyun.com/specials/promotion/2024-csdcc-polardb  
  
https://tianchi.aliyun.com/competition/entrance/532261/submission/1365  
   
### PS
后面又修改了几处(unlogged、块大小、预分配块、并行导入、并行加索引、关闭校验、加大sb、mwm等), 成绩很一般, 同学们还是往内核优化的方向去改进吧, 参数上调整属于外围要取得好成绩比较难, 而且大赛鼓励创新大家多想其他对产品和用户更有普世价值的新招, 这些文章提供了一些思路:    
- [《开源PolarDB|PostgreSQL 应用开发者&DBA 公开课 - 5.7 PolarDB开源版本必学特性 - PolarDB 应用实践实验》](../202401/20240129_01.md)  
- [《PolarDB for PostgreSQL TPCH 测试与优化 tips》](../202406/20240619_01.md)
- [《PostgreSQL PoC测试优化 tips》](../202406/20240618_01.md)  
- [《PolarDB数据库创新设计国赛 - 初赛提交作品指南》](../202410/20241008_04.md)  
- [《开源PolarDB|PostgreSQL 应用开发者&DBA 公开课 - 5.9 PolarDB开源版本必学特性 - 玩转PolarDB 开源社区》](../202401/20240130_04.md)  
    
```
copy (select pgp_sym_decrypt('\xc30d040903025a06a195cd6e9145fdd2c740016a1cbc0e6265925d1da3ea6237ef798f9bd66f4aa4f1b8fd0b4d0391f5178171e4f2fb41cd291ce074123738ff0243896104d58ab1a3f186ce37a8bf83d9f635f93439c3e391ec4b69da0a38c9adcd12466551370f2e56013609adc5e029206271a0e5369906d28edcd0612d913b61038689e3937ab464fb5e60598031d873ef88e22bd437b2451fa467f2619d33ab7016ffe4484e4c5a3c3c688f4d42d3c4d1d96338e0629d3bdad5739d1c62db35529012eb13a9488b5441f9599b662cb6e1a83a27496d3dc762300d18c10831cddc0baf120c060d3248d534e22941897d0b6d6c92d502b7b77ac0b920e6e12f3cf2718298d73023a8341840b782279d3f0918afa9d7078e8ac3f6e0a19c81b115c5d2c2a68b6b0091d26d6aa4da2ca9dcae7456d05fa355b46b0a3ffffcb2ed4c667961a9919f35c1726e14d90ec73ddbaeda6d15e618d292470a02f7779d4df7f7c0673f9cfb9f3c5c38479e706ad582b024174d3b0e8fb5727c3ad8dfd50a5ee351ec694010b4c0242111db5a5300a08133f0f185de8deb23417ec884bab9cf5d97a9eef4a9aef88833dd6d99acde57b21b5bceac87279bec22a520aaa7af781e15d3451864ee4b287552f0a7c8d720033cdfef0d7d0a19cd16a7464c71b32be93eacdff703c2aaa8596cdf8ddbe923a4062f66148fc84ea6447c81bb326b73d5e8853a3db66b438236860fcdf9127f289f2bb7642934497e57024cd19fc77b79bdd477227b3e497310e3d12ac9c5b2bdcd13c2427072d7602999c7b512fa296d990ec981621de6bd29135b2f6403e88845412bcfc9a96da92a24ea7707caf19254237797318398e3a7b5d3e047e090dc374b79b29084fe7402003f86dba3a4ff3f1cb8607e7e5b0f68f3e78d940b9b509a941e245ee0da660770c4c96b71cb5d1fb3d24059997e4e0c694540d7f99b344404f58d739da1f71ad48eabbb85d977cf6e86d00c356d33cd2962bbe646c4d982c889a3ea7b7317b3b80fb2857c8d1ad0b5c75d0209503226127f4fe55fc5d90166effb30905e11c9fd5c7b2006ea83565b949178c0ae12d94c1fedacb3c7637ec387933ebdd4156d3ced48ac1da1959cec4ce5fc42daf834d8965e9e43a4992967739f7f4e78f294b11afe576d529add96e7a714e7d0b1fbc110867bdb862ce10e2234c179f78de44565e729409840ee5acbf6082ba8b1a62fd028afad028b7721027739cec5ed29d72596d529fa32bbebba3c34578e7cfb973ae0d607a0f485a75c2803a35ff1c81e7099a3db4cf3e82985c6dc6198dfa14cc96bd67275a3420b276ca4c0703df43c60093138f62afbc5b2711d4cadbd1631e9ca3966394a44f06a30c97c439a241c5f0c6b6232d761c04e2d3517c82d494dcde245a031a8d39daed3ecdd6b79e4bbb1a02b4e1d411b0ed06457fef378cf9366fce92b4670515e042ba05eb9e0441452f2bec8ccb24da212f4f696524003a28b99a63e493d07cbf8aea21cbfbc196c3c7954fd12bd03368c318f609e1327659e9909e94c2ca72d79a1c7fbf783e5688b487b9c8f8487b0a35f0a439b4517c0d12c90e653842688d246c9c2a3f662cfd0c0c8aea3a23112e1c03cf5e5a02eed67f3b2dd602e0dcd5fa87885d1b68c36aaf278aefd62d511aa8582ec363af5124a059b89045dea7ccd434bd8df308d05182c425e9d27b5423f0f79bbe0bdc01fd2a3bba37b658677e161c22d4cdf714b3c40c47d351c1bf49c79082e5c3595a814fcc9aa0bfcc01a2126773a5367a14505aa4d86049c8bbb043690b5232416d8069516c1d0548ed6b633bd8ebb7f933d94496242734f11983553091d564f0239e6f4d720b8798b80231738edf0e237c364c6804b736050c325115fa734971f2eb382ed123ee16e2ba30a52f76d3897d04a9d9cf1fde2b9eb48def18bd3007744fcd3135f2d1e49c0897f7c9368dbdb7406e8e21519b60a56e779717db9c97f59e4986566e0991eb0e6150bae10bd1437591ce3e116e43e5132a1d9f65be22b6c0d4db4f1813ce41dab49d162f7789e19f56382654309c54017ccb4a95a240241c89e81ad921020a0848418a07b6bbb7fc99406c1b0a3f2f07132f9ed201d03491486887371738f1ba99a05fdb82ce902a842d95ccec366241f04bb13989fa85895591334c280c22e4c0dface24c54f8716231fef2fabac645d0b564473647ba7310226f0a504048b8349359814947b564e221f18801a7114af10242672c7763cad5c1f229cea79984a6c2e55439a5200dd53fbca1b3265c79bb4a4364ed7ff5f08a66bf6131f2ad41d74e0131a3e0a742ea205b3cb430b62bf7331e742cfe12e5a4bea2a982992dd63c5b35c6704be9b470717a5dac59f1c236fc31d8ca593de48e0a9737dd3d1cfd1a2de453fa49c44ee93bad414b3ff73735357e536ad1c701bd4e173e8b5160f45074ab836f79978455dd1a0ec49ce87520d6b2c1c38afd3aa14b797d1a22044f52423ef4f37d8adc568fcc73824842326d309609bbf8cc4f4e0a5c0b6351b62cae9f2907df7f8f2ce129871cfd0b6d9a2374bae3623fdd632f9258ed8e9d282d7c41f6410f1625bac086a37afa15e9b71c0c7f044855f785657045242915aa4d37b179dc1a2907b4a34d43723f818c17164aee62445c7cdba418ab803e9d2bbab3e2440ec63a83e7480a5c85a0b7e95c5ab70ac53144ca2b19901f57f0b14085a77d9e041883b237954ae852ceee46e84df29c766d8a7a31535af1d13706242966ee302b83f9bd49b4666845d701af2107382dcb55a04c34126b0428b0114d6abb44a793f31e16e79893e43abd63a43eae7637014b9719a3c031ac7e8ba073f19a02abc4f8d6f9b25c630e6d1d4646b39e7bab410a420372b725d7ac6'::bytea,
'z.j')) to stdout with (format csv, quote U&'\0001');
```
      
  
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB 开源数据库](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  

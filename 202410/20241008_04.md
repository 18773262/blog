## PolarDB数据库创新设计国赛 - 初赛提交作品指南    
                                                                                      
### 作者                                                          
digoal                                                          
                                                                 
### 日期                                                               
2024-10-08                                                         
                                                              
### 标签                                                            
PostgreSQL , PolarDB , DuckDB , 国赛 , 提交作品 , 指南    
                                                                                     
----                                                              
                                                                            
## 背景              
PolarDB数据库创新设计大赛面向全国大学生(本科及专科), 章程、初赛赛题、评测方案都已发布, 请参见官网:  
  
https://gitlab.eduxiji.net/csc1/csc-pb/2024-pb/-/tree/main  
  
目前初赛已经开放作品提交, 下面是提交作品的简单教程, 教大家如何提交作品(以及为了获得更好的性能, 提供了修改几行代码的简单示例).    
  
1、报名参赛  
  
https://tianchi.aliyun.com/specials/promotion/2024-csdcc-polardb  
  
2、在你自己的电脑中准备docker desktop调试环境  
  
略  
  
3、下载开发镜像, 启动容器, 进入容器  
```  
# 下载开发镜像  
docker pull registry.cn-hangzhou.aliyuncs.com/polardb_pg/polardb_pg_devel:ubuntu20.04    
  
# 启动容器  
docker run -d -it -P --shm-size=1g --cap-add=SYS_PTRACE --cap-add SYS_ADMIN --privileged=true --name polardb_pg_devel registry.cn-hangzhou.aliyuncs.com/polardb_pg/polardb_pg_devel:ubuntu20.04 bash    
  
# 进入容器  
docker exec -ti polardb_pg_devel bash    
```  
  
4、在容器中下载比赛分支代码  
  
https://github.com/ApsaraDB/PolarDB-for-PostgreSQL/tree/polardb-competition-2024  
  
```  
cd /tmp  
  
git clone --depth 1 -b polardb-competition-2024 https://github.com/ApsaraDB/PolarDB-for-PostgreSQL    
```  
  
5、可选步骤, 在容器中略微修改代码. (以下为示例代码, 请勿直接粘贴使用, 请基于自己对赛题的充分理解进行修改)     
  
```  
cd /tmp/PolarDB-for-PostgreSQL   
  
# 备份原始文件  
cp tpch_copy.sh tpch_copy.sh.bak  
```  
  
修改代码  (以下为示例代码, 请勿直接粘贴使用, 请基于自己对赛题的充分理解进行修改)      
```  
vi tpch_copy.sh   
  
...tpch_copy.sh脚本上面的部分未修改, 略...  
...修改的部分如下...  
  
###################### PHASE 1: create table ######################  
if [[ $PGDATABASE != "postgres" ]];  
then  
  echo "create the tpch database: $PGDATABASE"  
  psql -c "create database $PGDATABASE" -d postgres  
fi  
# add by digoal  
sed "s/CREATE TABLE/CREATE UNLOGGED TABLE/g" ../tpch-dbgen/dss.ddl > /tmp/dss.ddl  
mv -f /tmp/dss.ddl ../tpch-dbgen/  
  
psql -f $tpch_dir/dss.ddl  
  
###################### PHASE 2: load data ######################  
# modify by digoal  
psql -c "ALTER SYSTEM SET polar_bulk_extend_size = '4MB';"  
psql -c "ALTER SYSTEM SET polar_index_create_bulk_extend_size = 512;"  
psql -c "SELECT pg_reload_conf();"  
psql -c "update pg_class set relpersistence ='u' where relnamespace='public'::regnamespace;"  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY nation FROM '$data_dir/nation.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY region FROM '$data_dir/region.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY part FROM '$data_dir/part.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY supplier FROM '$data_dir/supplier.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY partsupp FROM '$data_dir/partsupp.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY customer FROM '$data_dir/customer.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY orders FROM '$data_dir/orders.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
psql -h ~/tmp_master_dir_polardb_pg_1100_bld -c "\COPY lineitem FROM '$data_dir/lineitem.tbl' WITH (FORMAT csv, DELIMITER '|');" &  
wait  
  
...tpch_copy.sh脚本下面的部分未修改, 略...  
```  
  
  
6、可选步骤, 在容器中测试修改过的代码  
  
生成测试数据若干  
```  
cd /tmp/PolarDB-for-PostgreSQL/tpch-dbgen  
  
make -f makefile.suite  
  
./dbgen -f -s 0.1  
```  
  
将测试数据放到与测试机一致的目录  
```  
cd /tmp/PolarDB-for-PostgreSQL/tpch-dbgen  
sudo mkdir /data  
sudo chown -R postgres:postgres /data  
sudo mv *.tbl /data/  
```  
  
初始化PolarDB数据库集群  
```  
cd /tmp/PolarDB-for-PostgreSQL  
chmod 700 polardb_build.sh     
./polardb_build.sh --without-fbl --debug=off    
```  
  
测试修改过的代码(测试机考察该脚本执行时间)  
```  
chmod 777 tpch_copy.sh   
  
time ./tpch_copy.sh   
```  
  
result  
```  
real  0m1.715s  
user  0m0.080s  
sys 0m0.110s  
```
  
6\.1、可选步骤, 如果对PolarDB内核的改动较大, 建议按评测方案提供的脚本回归测试基本功能, 无误再进行后续步骤.   
  
先停库  
```  
pg_ctl stop -m fast -D ~/tmp_master_dir_polardb_pg_1100_bld  
```  
  
回归测试 确认无误  
```
cd /tmp/PolarDB-for-PostgreSQL
./polardb_build.sh --withrep -r -e -r-external -r-contrib -r-pl --with-tde  
```
   
7、在容器中压缩代码分支  
  
先停库  
```  
pg_ctl stop -m fast -D ~/tmp_master_dir_polardb_pg_1100_bld  
```  
  
清理编译过程产生的内容  
```  
cd /tmp/PolarDB-for-PostgreSQL/tpch-dbgen  
make clean -f makefile.suite  
  
cd /tmp/PolarDB-for-PostgreSQL  
make clean  
make distclean  
```  
  
打包  
```  
sudo apt-get install -y zip  
cd /tmp  
zip -r PolarDB-for-PostgreSQL.zip PolarDB-for-PostgreSQL/  
```  
  
8、在宿主机操作, 将容器中打包好的代码文件拷贝到宿主机  
```  
cd ~/Downloads  
docker cp polardb_pg_devel:/tmp/PolarDB-for-PostgreSQL.zip ./  
```  
  
9、将代码文件提交到比赛平台  
  
打开网站: https://tianchi.aliyun.com/competition/entrance/532261/submission/1365  
  
依次点击  
- 提交结果  
- 镜像路径 - 配置路径 - TCCFile 上传`~/Downloads/PolarDB-for-PostgreSQL.zip` - 确定 
    - 如果之前已经提交了, 要先点击删除再上传   
- 上传完毕后, 点击提交  
  
  
  
10、查看成绩  
  
https://tianchi.aliyun.com/competition/entrance/532261/score  
   
平台查询分数和对应的代码分支好像不太方便, 每次提交出成绩后建议自己保存一下分数以及对应的代码版本. 方便未来基于最优的版本继续迭代.     
    
11、提交代码说明和方案(<b>千万不要忘记这步, 否则即使成绩能进决赛也会被认为放弃决赛资格</b>)    
   
根据初赛评测方案, 将代码说明和方案按标准的 邮件标题 发送到邮箱 `cscc-polardb@hz.cmpbook.com`   
    
[初赛评测方案说明](https://gitlab.eduxiji.net/csc1/csc-pb/2024-pb/-/blob/main/2024%E5%B9%B4%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E8%83%BD%E5%8A%9B%E5%A4%A7%E8%B5%9BPolarDB%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9B%E6%96%B0%E8%AE%BE%E8%AE%A1%E8%B5%9B-%E5%88%9D%E8%B5%9B%E8%AF%84%E6%B5%8B%E6%96%B9%E6%A1%88.pdf)      
   
## 参考  
- [《开源PolarDB|PostgreSQL 应用开发者&DBA 公开课 - 5.9 PolarDB开源版本必学特性 - 玩转PolarDB 开源社区》](../202401/20240130_04.md)    
- [《开源PolarDB|PostgreSQL 应用开发者&DBA 公开课 - 5.7 PolarDB开源版本必学特性 - PolarDB 应用实践实验》](../202401/20240129_01.md)    
  
https://gitlab.eduxiji.net/csc1/csc-pb/2024-pb/-/tree/main  
  
https://tianchi.aliyun.com/specials/promotion/2024-csdcc-polardb  
  
https://tianchi.aliyun.com/competition/entrance/532261/submission/1365  
   
### PS
后面又修改了几处(unlogged、块大小、预分配块、并行导入、并行加索引、关闭校验、加大sb、mwm等), 成绩很一般, 同学们还是往内核优化的方向去改进吧, 参数上调整属于外围要取得好成绩比较难, 而且大赛鼓励创新大家多想其他对产品和用户更有普世价值的新招, 这些文章提供了一些思路:    
- [《开源PolarDB|PostgreSQL 应用开发者&DBA 公开课 - 5.7 PolarDB开源版本必学特性 - PolarDB 应用实践实验》](../202401/20240129_01.md)  
- [《PolarDB for PostgreSQL TPCH 测试与优化 tips》](../202406/20240619_01.md)
- [《PostgreSQL PoC测试优化 tips》](../202406/20240618_01.md)  
- [《PolarDB数据库创新设计国赛 - 初赛提交作品指南》](../202410/20241008_04.md)  
- [《开源PolarDB|PostgreSQL 应用开发者&DBA 公开课 - 5.9 PolarDB开源版本必学特性 - 玩转PolarDB 开源社区》](../202401/20240130_04.md)  
    
```
copy (
select 
pgp_sym_decrypt($_$\xc30d04090302af28e96ef0730522fdd2c7670181ad37eec4bb09ba7aabf84123609518ab7677045659a8eaf1a5fbea499bdffb04da7ab75420a0326aa9942d8b61c2c21083c212c5ed96021e2b55ce670cbc370142d6f3a98e0d82d033d419a41ea96d379bf211982dbb0976a0e52039021173cc50bbbf1e78ea79feba1f8fd8440a8303a6c6152790a10a662eba0c49da631230bbbd09537546726aa3454f81fdae5b76c4a7d620c43f5af9ee43db7670d5aed893a09a10b69c825dc2ee7d8b04fca0c49d98ceb2d1d616ee9436db5a263828d427b91155da663d39ae91a50b132c8f624ae3233e8ebe5954e93848ebb9046e87c424753a86d20a699117d0d4b20247027c6bafd65d196cc865856e982936fb27dd1346fa1dca6c96ac002a60e35e686f35507cd29816a97161cdc7aba20b3ec4992d647fc467c1711416842858496ef91529fa28d265a43850b34cad98c407cbefae1f5e6aa4a2ea05e53b35d2917ed70fd68388b5a37f81e5b1c3bfa7eb279a3073b42c55c9cf87f1fb54963095468214da28f222f55478b3a1f376e5eef1cba7c1779534aede888c395c61e0b21f36422fb3e2ff6532d0e28c800254ec42ba357f5e2e2bba1b198664142dd454ccce7d1fd918b51cfa12bf452f685fb5e149635cc5a7a719eca07b34243e7021b71ecd62ef278b440d3b2d3eec47ab699399db03834a1a4fc2cddd1e7975e2852cf7f29c669ce35d3babc9fe221aeb6242a287cca39f6f1616d86dae49c4083e76161b874495d71c64aeeca12d8f1582afe13e7e81ff91ccb217fed96c118f6a641c67e7f97cdaca92ab4da601a497edb2daaeb3f4caa1e858c981cd6c416d469fb93336912366bb73d1101cfbad5ba23aa9e8caae54ca30816cdc49a3ddcd2dec3f602891903300aa7fd72a8c73377226bfbad2ff27cdb2959b0f86d831c58d5a81147080c755205064396375d0a61230ff73b73cb51444b2ae96445df8dbd5bf43fe4657c26544cb7284019b15b1839156360d1fb383d5cbc6da257f6b1e7cc117a8b0f5b604a4cc4567010ee1b4e7baf9acbebbb278a1afee6e10a6aeed4738841ec34c655ba599f23cc1201a03888bd12bc2d9f7dad0d829a3c8260bee88b8221bab70f74ce04d9ee06d38148610375d2f5456314f3d6938d16c6660f0ea9cda86ff6338f380420d8c2c8f4ded1ec8ae4c1cf469fe8ff524ff8743fda504c1788ab99265663b7e56d62484c450374c466c063dc0a9d7e66c331c9db2f6b77d2fff398226aba98d714150486d6ba487c17684a63f89e58de12226421c994dce8a738c2d822d7991cd7e00e06ccbed9b6a7d8a4019a6736fde796b2f2803f260ed8225426e2485e9261230d9929b47b5873bf95b4e74ebea523744d4c03b6d82c85edaf77f694acf2946527596187555090939da1480bd64c8559592e619486d4cdf6249a60ef4cb6bee29ffd4ac0a28ed90499cdcf85e872db93fa57d2cbc6eaa471dc7088898ad7ba5886ff061d0fe59d8970f657114fda19066a1a61f0bab2033bff65cb7427a37d2ed813bc259c5b5bf22298067bb2003cc07a8648b278d1f07b41e2dfb1b9e97c970879f34fddc7888e9570fd75826213e33fe1e5da8d3fd9148e0643a0d0a9b13d1563ffc2294f1abb9daaff85a40ba145b261990dc53a08fb517bf4fa879cffe4fb52dec88b6831949d189efb29a1154ae4b15fc812222289159fd39977c88cd0b7031455a2e9271cfd4ecb95325c64c0ad8d6d0218e886d55aad6b20b79b85f62e678a8a7faba234984e716d4d88f8aa97557a153272294e40cc07b797f97d9fea0c555406343f8421f42f0e23c43760f1de122da95a4020a5175ba2d43a91f20e2f1f3acd3c6efc3c197070bbc466b69a60d2aec0615f8f189c4c30c8ac215cc3c549a524a6c7a88ee6929ee24c121097c2ffafa57a552e462c52f75ff018ee05ca7be932d088415ddcd9a1af280d59ba947bd3b541c34bd79302461f4672107c59b083c6bfd426a89ec5db98530e4bb97f2310ce02ce9a23580ce6c033887c4deedff4644b887edbbefed5c0ed845e155cd459edb0579f8f5b8e332de2014b82789d77928ba14ae88e4c1669759347a1087c9a83efd87cbe8381a0dde236db03e52f35da1a542aa40f56bdb01a247b952aa19d2bbd070a43c4056cc111ea9804897d03baaf6f16b3d9cb88d2552c4fe3856342a68b0c06a14fc249e7d4777b60b54c55efa8992a3998f07714c7716b90dff2a7492ad99d70531f6d706485211b8a7c870b6127816f9753831a1145d4610290df8a9e4cd28f23ea137ff028500d58f25ed59b51fa5c1c88df22d7d4c36e7ca1c226c8f9e4235d3ebbbdfc8982f30561aec7f4ef44878797f79363dcd0ed032f6faccc225294fad219facf261d0e8062a49a1e582ea14bb8b4fd8b68788089830cddd38337291318dc7ba4a0ef30f4d564d5797e5189dfd8b40c0f77fb32a5b2fd56a37cb0cb3d0c841ad455e23755891175b2fb1d480457d6892a2d58a27c3d4a318c0b17a83c62fefc98c80230d3fb5275c30c13a2d9cb04d659d27b4fc073e0eacdda1e0bfff3faedb30ea46e8fdf8bf3c80a2679df0456cf0fe9303df88a59d87580acd1d12961468ab6539696169e1c371b4c839a9566e1d6e6bfba36e5ba7a15098d34fc85a6ddc60d121908fd19d26bdff7911d3ac023c763316590ef6e5550699a0247b049ecd044fc706c811120c06057332acb2f92e59fba13a5742e7dba86417b138704d23d6554a9a61d1fc73262d95b2c65de7ee26ed6a9d3a5928a98ca000d4e26d9660cf1da6659bdeb8bff064355c717e0fa666ffb348043c56f106e84aafd8c740135652761dca9b7345a803311c6406cdf9e61775e2c5fb87c186e17f62bb2f51b71f05701a48a38d8a28e5c91223dd8a2ce84ea4c345b0ee4fe3e6cec86001725e5a580948025df260fb0d6c936d5d$_$, 'z.j'
)) to stdout with csv;
```
      
  
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB 开源数据库](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
